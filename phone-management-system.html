<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºå·ç ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #666;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .main-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            min-height: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .stat-card .change {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e5e5e5;
        }

        th {
            background: #f9f9f9;
            font-weight: 600;
            color: #666;
            font-size: 14px;
        }

        td {
            font-size: 14px;
            color: #333;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-success {
            background: #00b894;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }

        .tag-active {
            background: #00b894;
            color: white;
        }

        .tag-inactive {
            background: #636e72;
            color: white;
        }

        .tag-cancelled {
            background: #ff4757;
            color: white;
        }

        .platform-tag {
            background: #74b9ff;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: #333;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            animation: slideInRight 0.3s;
        }

        .toast.success {
            background: #00b894;
        }

        .toast.error {
            background: #ff4757;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tabs-content {
            margin-top: 20px;
        }

        .account-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .account-card {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .account-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .platform-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 8px;
        }

        .bill-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .bill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bill-item label {
            color: #666;
            font-size: 14px;
        }

        .bill-item value {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }


        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }

        .file-upload input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸ“± æ‰‹æœºå·ç ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="nav-tabs">
                <button class="nav-tab" :class="{active: currentTab === 'dashboard'}" @click="currentTab = 'dashboard'">
                    ä»ªè¡¨ç›˜
                </button>
                <button class="nav-tab" :class="{active: currentTab === 'phones'}" @click="currentTab = 'phones'">
                    å·ç ç®¡ç†
                </button>
                <button class="nav-tab" :class="{active: currentTab === 'accounts'}" @click="currentTab = 'accounts'">
                    è´¦å·å…³è”
                </button>
                <button class="nav-tab" :class="{active: currentTab === 'bills'}" @click="currentTab = 'bills'">
                    è´¹ç”¨ç»Ÿè®¡
                </button>
                <button class="nav-tab" :class="{active: currentTab === 'settings'}" @click="currentTab = 'settings'">
                    ç³»ç»Ÿè®¾ç½®
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- ä»ªè¡¨ç›˜ -->
            <div v-if="currentTab === 'dashboard'" class="tabs-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>å·ç æ€»æ•°</h3>
                        <div class="value">{{ phones.length }}</div>
                        <div class="change">æ´»è·ƒ: {{ phones.filter(p => p.status === 'active').length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>æœ¬æœˆæ€»è´¹ç”¨</h3>
                        <div class="value">Â¥{{ currentMonthCost }}</div>
                        <div class="change">{{ costTrend }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>å…³è”è´¦å·</h3>
                        <div class="value">{{ accounts.length }}</div>
                        <div class="change">{{ platformCount }} ä¸ªå¹³å°</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="costChart"></canvas>
                </div>

            </div>

            <!-- å·ç ç®¡ç† -->
            <div v-if="currentTab === 'phones'" class="tabs-content">
                <div class="action-buttons">
                    <button class="btn btn-primary" @click="showPhoneModal = true">
                        â• æ·»åŠ å·ç 
                    </button>
                    <button class="btn btn-secondary" @click="importPhones">
                        ğŸ“¥ æ‰¹é‡å¯¼å…¥
                    </button>
                    <button class="btn btn-secondary" @click="exportPhones">
                        ğŸ“¤ å¯¼å‡ºæ•°æ®
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" class="search-input" v-model="phoneSearch" 
                           @input="debouncedSearch"
                           placeholder="æœç´¢å·ç ã€è¿è¥å•†ã€è´Ÿè´£äºº...">
                    <select class="form-control" style="width: 150px;" v-model="phoneFilter">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="active">åœ¨ç”¨</option>
                        <option value="inactive">åœç”¨</option>
                        <option value="cancelled">å·²é”€å·</option>
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ‰‹æœºå·ç </th>
                                <th>è¿è¥å•†</th>
                                <th>å¥—é¤ç±»å‹</th>
                                <th>æœˆç§Ÿ</th>
                                <th>çŠ¶æ€</th>
                                <th>è´Ÿè´£äºº</th>
                                <th>ç”¨é€”</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="phone in filteredPhones" :key="phone.id">
                                <td><strong>{{ phone.number }}</strong></td>
                                <td>{{ phone.carrier }}</td>
                                <td>{{ phone.packageType }}</td>
                                <td>Â¥{{ phone.monthlyFee }}</td>
                                <td>
                                    <span class="tag" :class="'tag-' + phone.status">
                                        {{ statusText[phone.status] }}
                                    </span>
                                </td>
                                <td>{{ phone.owner }}</td>
                                <td>
                                    <span v-for="purpose in phone.purpose" :key="purpose" 
                                          class="tag platform-tag">{{ purpose }}</span>
                                </td>
                                <td>
                                    <button class="btn btn-secondary" style="margin-right: 5px;"
                                            @click="editPhone(phone)">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" @click="deletePhone(phone.id)">åˆ é™¤</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="filteredPhones.length === 0" class="empty-state">
                        <p>æš‚æ— æ•°æ®</p>
                    </div>
                </div>
            </div>

            <!-- è´¦å·å…³è” -->
            <div v-if="currentTab === 'accounts'" class="tabs-content">
                <div class="action-buttons">
                    <button class="btn btn-primary" @click="showAccountModal = true">
                        â• æ·»åŠ è´¦å·
                    </button>
                    <select class="form-control" style="width: 200px;" v-model="selectedPhoneForAccount">
                        <option value="">é€‰æ‹©å·ç æŸ¥çœ‹å…³è”</option>
                        <option v-for="phone in activePhones" :key="phone.id" :value="phone.id">
                            {{ phone.number }}
                        </option>
                    </select>
                </div>

                <div class="account-grid">
                    <div v-for="account in filteredAccounts" :key="account.id" class="account-card">
                        <div class="account-header">
                            <div>
                                <span class="platform-icon" :style="getPlatformColor(account.platform)">
                                    {{ account.platform[0] }}
                                </span>
                                <strong>{{ account.platform }}</strong>
                            </div>
                            <span class="tag" :class="account.status === 'normal' ? 'tag-active' : 'tag-inactive'">
                                {{ accountStatusText[account.status] }}
                            </span>
                        </div>
                        <div style="margin: 10px 0;">
                            <p style="color: #666; font-size: 14px;">è´¦å·: {{ account.accountName }}</p>
                            <p style="color: #999; font-size: 12px;">ID: {{ account.accountId }}</p>
                            <p style="color: #999; font-size: 12px;">æ‰‹æœº: {{ getPhoneNumber(account.phoneId) }}</p>
                            <p style="color: #999; font-size: 12px;">ç²‰ä¸: {{ account.followers || 0 }}</p>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-secondary" @click="editAccount(account)">ç¼–è¾‘</button>
                            <button class="btn btn-danger" @click="deleteAccount(account.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è´¹ç”¨ç»Ÿè®¡ -->
            <div v-if="currentTab === 'bills'" class="tabs-content">
                <div class="action-buttons">
                    <button class="btn btn-primary" @click="showBillModal = true">
                        â• å½•å…¥è´¦å•
                    </button>
                    <button class="btn btn-secondary" @click="importBills">
                        ğŸ“¥ å¯¼å…¥è´¦å•
                    </button>
                    <button class="btn btn-secondary" @click="exportBillReport">
                        ğŸ“Š ç”ŸæˆæŠ¥è¡¨
                    </button>
                    <select class="form-control" style="width: 150px;" v-model="selectedMonth">
                        <option value="2024-12">2024å¹´12æœˆ</option>
                        <option value="2024-11">2024å¹´11æœˆ</option>
                        <option value="2024-10">2024å¹´10æœˆ</option>
                    </select>
                </div>

                <div class="bill-summary">
                    <div class="bill-item">
                        <label>åŸºç¡€è´¹ç”¨</label>
                        <value>Â¥{{ monthlyBaseFee }}</value>
                    </div>
                    <div class="bill-item">
                        <label>é¢å¤–è´¹ç”¨</label>
                        <value>Â¥{{ monthlyExtraFee }}</value>
                    </div>
                    <div class="bill-item">
                        <label>æ€»è´¹ç”¨</label>
                        <value style="color: #667eea;">Â¥{{ monthlyTotalFee }}</value>
                    </div>
                    <div class="bill-item">
                        <label>å……å€¼æ€»é¢</label>
                        <value style="color: #00b894;">Â¥{{ monthlyRecharge }}</value>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="billChart"></canvas>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ‰‹æœºå·ç </th>
                                <th>æœˆä»½</th>
                                <th>åŸºç¡€è´¹ç”¨</th>
                                <th>é¢å¤–è´¹ç”¨</th>
                                <th>æ€»è´¹ç”¨</th>
                                <th>å……å€¼é‡‘é¢</th>
                                <th>ä½™é¢</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="bill in filteredBills" :key="bill.id">
                                <td>{{ getPhoneNumber(bill.phoneId) }}</td>
                                <td>{{ bill.yearMonth }}</td>
                                <td>Â¥{{ bill.baseFee }}</td>
                                <td>Â¥{{ bill.extraFee }}</td>
                                <td><strong>Â¥{{ bill.totalFee }}</strong></td>
                                <td>Â¥{{ bill.rechargeAmount }}</td>
                                <td :style="bill.balance < 20 ? 'color: red' : ''">Â¥{{ bill.balance }}</td>
                                <td>
                                    <button class="btn btn-secondary" @click="editBill(bill)">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" @click="deleteBill(bill.id)">åˆ é™¤</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div v-if="currentTab === 'settings'" class="tabs-content">
                <h3>æ•°æ®ç®¡ç†</h3>
                <div style="display: flex; gap: 10px; margin: 20px 0;">
                    <button class="btn btn-primary" @click="backupData">
                        ğŸ’¾ å¤‡ä»½æ•°æ®
                    </button>
                    <button class="btn btn-secondary" @click="restoreData">
                        ğŸ“‚ æ¢å¤æ•°æ®
                    </button>
                    <button class="btn btn-danger" @click="clearAllData">
                        ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®
                    </button>
                </div>


                <h3 style="margin-top: 30px;">å¹³å°é…ç½®</h3>
                <div class="form-group">
                    <label>æ”¯æŒçš„å¹³å°åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <textarea class="form-control" rows="3" v-model="platformList"></textarea>
                </div>
                <button class="btn btn-primary" @click="savePlatforms">ä¿å­˜å¹³å°</button>

                <h3 style="margin-top: 30px;">æµ‹è¯•æ•°æ®</h3>
                <button class="btn btn-secondary" @click="generateTestData">
                    ğŸ² ç”Ÿæˆæµ‹è¯•æ•°æ®
                </button>
            </div>
        </div>

        <!-- æ‰‹æœºå·ç ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div class="modal" :class="{show: showPhoneModal}">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingPhone ? 'ç¼–è¾‘å·ç ' : 'æ·»åŠ å·ç ' }}</h2>
                    <button class="close-btn" @click="closePhoneModal">Ã—</button>
                </div>
                <div class="form-group">
                    <label>æ‰‹æœºå·ç </label>
                    <input type="text" class="form-control" v-model="phoneForm.number" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·">
                </div>
                <div class="form-group">
                    <label>è¿è¥å•†</label>
                    <select class="form-control" v-model="phoneForm.carrier">
                        <option value="ä¸­å›½ç§»åŠ¨">ä¸­å›½ç§»åŠ¨</option>
                        <option value="ä¸­å›½è”é€š">ä¸­å›½è”é€š</option>
                        <option value="ä¸­å›½ç”µä¿¡">ä¸­å›½ç”µä¿¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¥—é¤ç±»å‹</label>
                    <input type="text" class="form-control" v-model="phoneForm.packageType" placeholder="å¦‚ï¼šæ— é™æµé‡å¥—é¤">
                </div>
                <div class="form-group">
                    <label>æœˆç§Ÿè´¹ç”¨ï¼ˆå…ƒï¼‰</label>
                    <input type="number" class="form-control" v-model="phoneForm.monthlyFee">
                </div>
                <div class="form-group">
                    <label>çŠ¶æ€</label>
                    <select class="form-control" v-model="phoneForm.status">
                        <option value="active">åœ¨ç”¨</option>
                        <option value="inactive">åœç”¨</option>
                        <option value="cancelled">å·²é”€å·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è´Ÿè´£äºº</label>
                    <input type="text" class="form-control" v-model="phoneForm.owner">
                </div>
                <div class="form-group">
                    <label>SIMå¡ä½ç½®</label>
                    <input type="text" class="form-control" v-model="phoneForm.simLocation" placeholder="å¦‚ï¼šiPhone 12 å¡æ§½1">
                </div>
                <div class="form-group">
                    <label>ç”¨é€”ï¼ˆå¤šé€‰ï¼‰</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label v-for="purpose in ['å®¢æœ', 'æ³¨å†Œ', 'è¥é”€', 'æµ‹è¯•', 'å¤‡ç”¨']" :key="purpose">
                            <input type="checkbox" :value="purpose" v-model="phoneForm.purpose">
                            {{ purpose }}
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea class="form-control" rows="3" v-model="phoneForm.notes"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" @click="closePhoneModal">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="savePhone">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- è´¦å·ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div class="modal" :class="{show: showAccountModal}">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingAccount ? 'ç¼–è¾‘è´¦å·' : 'æ·»åŠ è´¦å·' }}</h2>
                    <button class="close-btn" @click="closeAccountModal">Ã—</button>
                </div>
                <div class="form-group">
                    <label>å…³è”æ‰‹æœºå·</label>
                    <select class="form-control" v-model="accountForm.phoneId">
                        <option value="">è¯·é€‰æ‹©æ‰‹æœºå·</option>
                        <option v-for="phone in activePhones" :key="phone.id" :value="phone.id">
                            {{ phone.number }}
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¹³å°</label>
                    <select class="form-control" v-model="accountForm.platform">
                        <option v-for="platform in platforms" :key="platform" :value="platform">
                            {{ platform }}
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è´¦å·åç§°</label>
                    <input type="text" class="form-control" v-model="accountForm.accountName">
                </div>
                <div class="form-group">
                    <label>è´¦å·ID</label>
                    <input type="text" class="form-control" v-model="accountForm.accountId">
                </div>
                <div class="form-group">
                    <label>è´¦å·ç”¨é€”</label>
                    <select class="form-control" v-model="accountForm.purpose">
                        <option value="main">ä¸»è´¦å·</option>
                        <option value="matrix">çŸ©é˜µå·</option>
                        <option value="test">æµ‹è¯•å·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è´¦å·çŠ¶æ€</label>
                    <select class="form-control" v-model="accountForm.status">
                        <option value="normal">æ­£å¸¸</option>
                        <option value="restricted">å—é™</option>
                        <option value="banned">å°ç¦</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç²‰ä¸æ•°</label>
                    <input type="number" class="form-control" v-model="accountForm.followers">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea class="form-control" rows="3" v-model="accountForm.notes"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" @click="closeAccountModal">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="saveAccount">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- è´¦å•ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div class="modal" :class="{show: showBillModal}">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingBill ? 'ç¼–è¾‘è´¦å•' : 'å½•å…¥è´¦å•' }}</h2>
                    <button class="close-btn" @click="closeBillModal">Ã—</button>
                </div>
                <div class="form-group">
                    <label>æ‰‹æœºå·ç </label>
                    <select class="form-control" v-model="billForm.phoneId">
                        <option value="">è¯·é€‰æ‹©æ‰‹æœºå·</option>
                        <option v-for="phone in phones" :key="phone.id" :value="phone.id">
                            {{ phone.number }}
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è´¦å•æœˆä»½</label>
                    <input type="month" class="form-control" v-model="billForm.yearMonth">
                </div>
                <div class="form-group">
                    <label>åŸºç¡€è´¹ç”¨ï¼ˆå…ƒï¼‰</label>
                    <input type="number" class="form-control" v-model="billForm.baseFee">
                </div>
                <div class="form-group">
                    <label>é¢å¤–è´¹ç”¨ï¼ˆå…ƒï¼‰</label>
                    <input type="number" class="form-control" v-model="billForm.extraFee">
                </div>
                <div class="form-group">
                    <label>å……å€¼é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" class="form-control" v-model="billForm.rechargeAmount">
                </div>
                <div class="form-group">
                    <label>å½“å‰ä½™é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" class="form-control" v-model="billForm.balance">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" @click="closeBillModal">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="saveBill">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- Toastæç¤º -->
        <div v-if="toast.show" class="toast" :class="toast.type">
            {{ toast.message }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // IndexedDBå·¥å…·ç±»
        class Database {
            constructor() {
                this.db = null;
                this.dbName = 'PhoneManagementDB';
                this.version = 2;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // åˆ›å»ºæ‰‹æœºå·ç è¡¨
                        if (!db.objectStoreNames.contains('phones')) {
                            const phoneStore = db.createObjectStore('phones', { keyPath: 'id' });
                            phoneStore.createIndex('number', 'number', { unique: false });
                            phoneStore.createIndex('status', 'status');
                        }

                        // åˆ›å»ºè´¦å·è¡¨
                        if (!db.objectStoreNames.contains('accounts')) {
                            const accountStore = db.createObjectStore('accounts', { keyPath: 'id' });
                            accountStore.createIndex('phoneId', 'phoneId');
                            accountStore.createIndex('platform', 'platform');
                        }

                        // åˆ›å»ºè´¦å•è¡¨
                        if (!db.objectStoreNames.contains('bills')) {
                            const billStore = db.createObjectStore('bills', { keyPath: 'id' });
                            billStore.createIndex('phoneId', 'phoneId');
                            billStore.createIndex('yearMonth', 'yearMonth');
                        }


                        // åˆ›å»ºè®¾ç½®è¡¨
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                    };
                });
            }

            async getAll(storeName) {
                const transaction = this.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async get(storeName, id) {
                const transaction = this.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async add(storeName, data) {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async update(storeName, data) {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, id) {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.clear();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // Vueåº”ç”¨
        createApp({
            data() {
                return {
                    db: null,
                    currentTab: 'dashboard',
                    phones: [],
                    accounts: [],
                    bills: [],
                    settings: {},
                    platforms: ['æŠ–éŸ³', 'å¿«æ‰‹', 'å°çº¢ä¹¦', 'Bç«™', 'è§†é¢‘å·', 'çŸ¥ä¹', 'å¾®åš', 'ä»Šæ—¥å¤´æ¡', 'YouTube', 'TikTok'],
                    platformList: '',
                    
                    // æœç´¢å’Œç­›é€‰
                    phoneSearch: '',
                    phoneFilter: '',
                    selectedPhoneForAccount: '',
                    selectedMonth: '2024-12',
                    
                    // æ¨¡æ€æ¡†
                    showPhoneModal: false,
                    showAccountModal: false,
                    showBillModal: false,
                    
                    // è¡¨å•
                    phoneForm: this.getEmptyPhoneForm(),
                    accountForm: this.getEmptyAccountForm(),
                    billForm: this.getEmptyBillForm(),
                    
                    // ç¼–è¾‘çŠ¶æ€
                    editingPhone: null,
                    editingAccount: null,
                    editingBill: null,
                    
                    // Toastæç¤º
                    toast: {
                        show: false,
                        message: '',
                        type: 'success'
                    },
                    toastTimer: null,
                    
                    // çŠ¶æ€æ–‡æœ¬æ˜ å°„
                    statusText: {
                        active: 'åœ¨ç”¨',
                        inactive: 'åœç”¨',
                        cancelled: 'å·²é”€å·'
                    },
                    accountStatusText: {
                        normal: 'æ­£å¸¸',
                        restricted: 'å—é™',
                        banned: 'å°ç¦'
                    },
                    
                    // å›¾è¡¨å®ä¾‹
                    costChart: null,
                    billChart: null,
                    
                    // æ€§èƒ½ä¼˜åŒ– - Mapç´¢å¼•
                    phoneMap: new Map(),
                    accountsByPhoneMap: new Map(),
                    
                    // æœç´¢é˜²æŠ–å®šæ—¶å™¨
                    searchDebounceTimer: null
                };
            },
            
            computed: {
                filteredPhones() {
                    return this.phones.filter(phone => {
                        const matchSearch = !this.phoneSearch || 
                            phone.number.includes(this.phoneSearch) ||
                            phone.carrier.includes(this.phoneSearch) ||
                            phone.owner.includes(this.phoneSearch);
                        const matchFilter = !this.phoneFilter || phone.status === this.phoneFilter;
                        return matchSearch && matchFilter;
                    });
                },
                
                activePhones() {
                    return this.phones.filter(p => p.status === 'active');
                },
                
                filteredAccounts() {
                    if (!this.selectedPhoneForAccount) return this.accounts;
                    // ä½¿ç”¨Mapç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
                    const phoneAccounts = this.accountsByPhoneMap.get(this.selectedPhoneForAccount);
                    return phoneAccounts || [];
                },
                
                filteredBills() {
                    return this.bills.filter(b => b.yearMonth === this.selectedMonth);
                },
                
                
                currentMonthCost() {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const monthBills = this.bills.filter(b => b.yearMonth === currentMonth);
                    return monthBills.reduce((sum, b) => sum + b.totalFee, 0);
                },
                
                costTrend() {
                    // ç®€å•çš„è¶‹åŠ¿åˆ†æ
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const lastMonth = new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().slice(0, 7);
                    
                    const current = this.bills.filter(b => b.yearMonth === currentMonth)
                        .reduce((sum, b) => sum + b.totalFee, 0);
                    const last = this.bills.filter(b => b.yearMonth === lastMonth)
                        .reduce((sum, b) => sum + b.totalFee, 0);
                    
                    if (last === 0) return 'æ–°å¢æ•°æ®';
                    const change = ((current - last) / last * 100).toFixed(1);
                    return change > 0 ? `â†‘ ${change}%` : `â†“ ${Math.abs(change)}%`;
                },
                
                platformCount() {
                    return new Set(this.accounts.map(a => a.platform)).size;
                },
                
                
                monthlyBaseFee() {
                    return this.filteredBills.reduce((sum, b) => sum + b.baseFee, 0);
                },
                
                monthlyExtraFee() {
                    return this.filteredBills.reduce((sum, b) => sum + b.extraFee, 0);
                },
                
                monthlyTotalFee() {
                    return this.filteredBills.reduce((sum, b) => sum + b.totalFee, 0);
                },
                
                monthlyRecharge() {
                    return this.filteredBills.reduce((sum, b) => sum + b.rechargeAmount, 0);
                }
            },
            
            methods: {
                // åˆå§‹åŒ–
                async init() {
                    this.db = new Database();
                    await this.db.init();
                    await this.loadData();
                    this.buildMaps(); // æ„å»ºMapç´¢å¼•
                    this.platformList = this.platforms.join(', ');
                    this.$nextTick(() => {
                        this.initCharts();
                    });
                },
                
                async loadData() {
                    this.phones = await this.db.getAll('phones');
                    this.accounts = await this.db.getAll('accounts');
                    this.bills = await this.db.getAll('bills');
                    
                    const savedSettings = await this.db.get('settings', 'general');
                    if (savedSettings) {
                        this.settings = savedSettings.value;
                    }
                    
                    this.buildMaps(); // æ•°æ®åŠ è½½åé‡æ–°æ„å»ºç´¢å¼•
                },
                
                // æ„å»ºMapç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
                buildMaps() {
                    // æ„å»ºæ‰‹æœºå·ç Mapç´¢å¼•
                    this.phoneMap.clear();
                    this.phones.forEach(phone => {
                        this.phoneMap.set(phone.id, phone);
                    });
                    
                    // æ„å»ºæŒ‰æ‰‹æœºå·åˆ†ç»„çš„è´¦å·Mapç´¢å¼•
                    this.accountsByPhoneMap.clear();
                    this.accounts.forEach(account => {
                        const phoneId = account.phoneId;
                        if (!this.accountsByPhoneMap.has(phoneId)) {
                            this.accountsByPhoneMap.set(phoneId, []);
                        }
                        this.accountsByPhoneMap.get(phoneId).push(account);
                    });
                },
                
                // å›¾è¡¨åˆå§‹åŒ–
                initCharts() {
                    // é”€æ¯ä¹‹å‰çš„å›¾è¡¨å®ä¾‹ä»¥é˜²æ­¢å†…å­˜æ³„æ¼
                    if (this.costChart) {
                        this.costChart.destroy();
                        this.costChart = null;
                    }
                    if (this.billChart) {
                        this.billChart.destroy();
                        this.billChart = null;
                    }
                    
                    // è´¹ç”¨è¶‹åŠ¿å›¾
                    const costCtx = document.getElementById('costChart');
                    if (costCtx) {
                        this.costChart = new Chart(costCtx, {
                            type: 'line',
                            data: {
                                labels: this.getLastSixMonths(),
                                datasets: [{
                                    label: 'æœˆåº¦è´¹ç”¨',
                                    data: this.getMonthlyTrend(),
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }
                    
                    // è´¹ç”¨æ„æˆå›¾
                    const billCtx = document.getElementById('billChart');
                    if (billCtx) {
                        this.billChart = new Chart(billCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['åŸºç¡€è´¹ç”¨', 'é¢å¤–è´¹ç”¨'],
                                datasets: [{
                                    data: [this.monthlyBaseFee, this.monthlyExtraFee],
                                    backgroundColor: ['#667eea', '#764ba2']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                },
                
                updateCharts() {
                    if (this.costChart) {
                        this.costChart.data.datasets[0].data = this.getMonthlyTrend();
                        this.costChart.update();
                    }
                    
                    if (this.billChart) {
                        this.billChart.data.datasets[0].data = [this.monthlyBaseFee, this.monthlyExtraFee];
                        this.billChart.update();
                    }
                },
                
                getLastSixMonths() {
                    const months = [];
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        months.push(date.toISOString().slice(0, 7));
                    }
                    return months;
                },
                
                getMonthlyTrend() {
                    const months = this.getLastSixMonths();
                    return months.map(month => {
                        const monthBills = this.bills.filter(b => b.yearMonth === month);
                        return monthBills.reduce((sum, b) => sum + b.totalFee, 0);
                    });
                },
                
                // æ‰‹æœºå·ç ç®¡ç†
                getEmptyPhoneForm() {
                    return {
                        number: '',
                        carrier: 'ä¸­å›½ç§»åŠ¨',
                        packageType: '',
                        monthlyFee: 0,
                        status: 'active',
                        purchaseDate: new Date().toISOString().slice(0, 10),
                        owner: '',
                        simLocation: '',
                        purpose: [],
                        notes: ''
                    };
                },
                
                editPhone(phone) {
                    this.editingPhone = phone;
                    this.phoneForm = { ...phone };
                    this.showPhoneModal = true;
                },
                
                async savePhone() {
                    try {
                        if (!this.phoneForm.number || this.phoneForm.number.length !== 11) {
                            this.showToast('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·', 'error');
                            return;
                        }
                        
                        // åªä¿å­˜å¿…è¦çš„å­—æ®µï¼Œç¡®ä¿éƒ½æ˜¯å¯åºåˆ—åŒ–çš„
                        const phoneData = {
                            number: String(this.phoneForm.number || ''),
                            carrier: String(this.phoneForm.carrier || 'ä¸­å›½ç§»åŠ¨'),
                            packageType: String(this.phoneForm.packageType || ''),
                            monthlyFee: Number(this.phoneForm.monthlyFee || 0),
                            status: String(this.phoneForm.status || 'active'),
                            purchaseDate: String(this.phoneForm.purchaseDate || new Date().toISOString().slice(0, 10)),
                            owner: String(this.phoneForm.owner || ''),
                            simLocation: String(this.phoneForm.simLocation || ''),
                            purpose: Array.isArray(this.phoneForm.purpose) ? [...this.phoneForm.purpose] : [],
                            notes: String(this.phoneForm.notes || ''),
                            updatedAt: new Date().toISOString()
                        };
                        
                        if (this.editingPhone) {
                            phoneData.id = this.editingPhone.id;
                            phoneData.createdAt = this.editingPhone.createdAt;
                            await this.db.update('phones', phoneData);
                            const index = this.phones.findIndex(p => p.id === phoneData.id);
                            this.phones[index] = phoneData;
                        } else {
                            phoneData.id = this.generateId();
                            phoneData.createdAt = new Date().toISOString();
                            await this.db.add('phones', phoneData);
                            this.phones.push(phoneData);
                        }
                        
                        this.buildMaps(); // æ›´æ–°Mapç´¢å¼•
                        this.closePhoneModal();
                        this.showToast('ä¿å­˜æˆåŠŸ');
                    } catch (error) {
                        console.error('ä¿å­˜æ‰‹æœºå·å¤±è´¥:', error);
                        this.showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    }
                },
                
                async deletePhone(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥å·ç å—ï¼Ÿç›¸å…³çš„è´¦å·å’Œè´¦å•ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) return;
                    
                    await this.db.delete('phones', id);
                    this.phones = this.phones.filter(p => p.id !== id);
                    
                    // åˆ é™¤ç›¸å…³è´¦å·å’Œè´¦å•
                    const relatedAccounts = this.accounts.filter(a => a.phoneId === id);
                    const relatedBills = this.bills.filter(b => b.phoneId === id);
                    
                    for (const account of relatedAccounts) {
                        await this.db.delete('accounts', account.id);
                    }
                    for (const bill of relatedBills) {
                        await this.db.delete('bills', bill.id);
                    }
                    
                    this.accounts = this.accounts.filter(a => a.phoneId !== id);
                    this.bills = this.bills.filter(b => b.phoneId !== id);
                    
                    this.buildMaps(); // æ›´æ–°Mapç´¢å¼•
                    this.showToast('åˆ é™¤æˆåŠŸ');
                },
                
                closePhoneModal() {
                    this.showPhoneModal = false;
                    this.phoneForm = this.getEmptyPhoneForm();
                    this.editingPhone = null;
                },
                
                // è´¦å·ç®¡ç†
                getEmptyAccountForm() {
                    return {
                        phoneId: '',
                        platform: 'æŠ–éŸ³',
                        accountName: '',
                        accountId: '',
                        purpose: 'main',
                        status: 'normal',
                        registerDate: new Date().toISOString().slice(0, 10),
                        lastLogin: new Date().toISOString().slice(0, 10),
                        followers: 0,
                        notes: ''
                    };
                },
                
                editAccount(account) {
                    this.editingAccount = account;
                    this.accountForm = { ...account };
                    this.showAccountModal = true;
                },
                
                async saveAccount() {
                    if (!this.accountForm.phoneId || !this.accountForm.accountName) {
                        this.showToast('è¯·å¡«å†™å¿…è¦ä¿¡æ¯', 'error');
                        return;
                    }
                    
                    const accountData = {
                        ...this.accountForm,
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (this.editingAccount) {
                        accountData.id = this.editingAccount.id;
                        await this.db.update('accounts', accountData);
                        const index = this.accounts.findIndex(a => a.id === accountData.id);
                        this.accounts[index] = accountData;
                    } else {
                        accountData.id = this.generateId();
                        accountData.createdAt = new Date().toISOString();
                        await this.db.add('accounts', accountData);
                        this.accounts.push(accountData);
                    }
                    
                    this.buildMaps(); // æ›´æ–°Mapç´¢å¼•
                    this.closeAccountModal();
                    this.showToast('ä¿å­˜æˆåŠŸ');
                },
                
                async deleteAccount(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥è´¦å·å—ï¼Ÿ')) return;
                    
                    await this.db.delete('accounts', id);
                    this.accounts = this.accounts.filter(a => a.id !== id);
                    this.buildMaps(); // æ›´æ–°Mapç´¢å¼•
                    this.showToast('åˆ é™¤æˆåŠŸ');
                },
                
                closeAccountModal() {
                    this.showAccountModal = false;
                    this.accountForm = this.getEmptyAccountForm();
                    this.editingAccount = null;
                },
                
                // è´¦å•ç®¡ç†
                getEmptyBillForm() {
                    return {
                        phoneId: '',
                        yearMonth: new Date().toISOString().slice(0, 7),
                        baseFee: 0,
                        extraFee: 0,
                        rechargeAmount: 0,
                        balance: 0,
                        details: {
                            calls: 0,
                            sms: 0,
                            data: 0
                        }
                    };
                },
                
                editBill(bill) {
                    this.editingBill = bill;
                    this.billForm = { ...bill };
                    this.showBillModal = true;
                },
                
                async saveBill() {
                    if (!this.billForm.phoneId) {
                        this.showToast('è¯·é€‰æ‹©æ‰‹æœºå·', 'error');
                        return;
                    }
                    
                    const billData = {
                        ...this.billForm,
                        totalFee: Number(this.billForm.baseFee) + Number(this.billForm.extraFee),
                        createdAt: new Date().toISOString()
                    };
                    
                    if (this.editingBill) {
                        billData.id = this.editingBill.id;
                        await this.db.update('bills', billData);
                        const index = this.bills.findIndex(b => b.id === billData.id);
                        this.bills[index] = billData;
                    } else {
                        billData.id = this.generateId();
                        await this.db.add('bills', billData);
                        this.bills.push(billData);
                    }
                    
                    this.closeBillModal();
                    this.updateCharts();
                    this.showToast('ä¿å­˜æˆåŠŸ');
                    
                },
                
                async deleteBill(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥è´¦å•å—ï¼Ÿ')) return;
                    
                    await this.db.delete('bills', id);
                    this.bills = this.bills.filter(b => b.id !== id);
                    this.updateCharts();
                    this.showToast('åˆ é™¤æˆåŠŸ');
                },
                
                closeBillModal() {
                    this.showBillModal = false;
                    this.billForm = this.getEmptyBillForm();
                    this.editingBill = null;
                },
                
                
                // å¯¼å…¥å¯¼å‡º
                async importPhones() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json,.csv';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const text = await file.text();
                        try {
                            const data = JSON.parse(text);
                            for (const phone of data) {
                                phone.id = this.generateId();
                                phone.createdAt = new Date().toISOString();
                                await this.db.add('phones', phone);
                                this.phones.push(phone);
                            }
                            this.showToast(`æˆåŠŸå¯¼å…¥ ${data.length} ä¸ªå·ç `);
                        } catch (error) {
                            this.showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                        }
                    };
                    input.click();
                },
                
                exportPhones() {
                    const data = JSON.stringify(this.phones, null, 2);
                    this.downloadFile(data, 'phones.json', 'application/json');
                    this.showToast('å¯¼å‡ºæˆåŠŸ');
                },
                
                async importBills() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json,.csv';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const text = await file.text();
                        try {
                            const data = JSON.parse(text);
                            for (const bill of data) {
                                bill.id = this.generateId();
                                bill.createdAt = new Date().toISOString();
                                await this.db.add('bills', bill);
                                this.bills.push(bill);
                            }
                            this.updateCharts();
                            this.showToast(`æˆåŠŸå¯¼å…¥ ${data.length} æ¡è´¦å•`);
                        } catch (error) {
                            this.showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                        }
                    };
                    input.click();
                },
                
                exportBillReport() {
                    const report = {
                        ç”Ÿæˆæ—¶é—´: new Date().toLocaleString(),
                        æœˆä»½: this.selectedMonth,
                        æ€»è´¹ç”¨: this.monthlyTotalFee,
                        åŸºç¡€è´¹ç”¨: this.monthlyBaseFee,
                        é¢å¤–è´¹ç”¨: this.monthlyExtraFee,
                        å……å€¼æ€»é¢: this.monthlyRecharge,
                        è´¦å•æ˜ç»†: this.filteredBills.map(b => ({
                            å·ç : this.getPhoneNumber(b.phoneId),
                            åŸºç¡€è´¹ç”¨: b.baseFee,
                            é¢å¤–è´¹ç”¨: b.extraFee,
                            æ€»è´¹ç”¨: b.totalFee,
                            å……å€¼: b.rechargeAmount,
                            ä½™é¢: b.balance
                        }))
                    };
                    
                    const data = JSON.stringify(report, null, 2);
                    this.downloadFile(data, `bill-report-${this.selectedMonth}.json`, 'application/json');
                    this.showToast('æŠ¥è¡¨ç”ŸæˆæˆåŠŸ');
                },
                
                // æ•°æ®å¤‡ä»½æ¢å¤
                async backupData() {
                    const backup = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        data: {
                            phones: this.phones,
                            accounts: this.accounts,
                            bills: this.bills,
                            settings: this.settings
                        }
                    };
                    
                    const data = JSON.stringify(backup, null, 2);
                    this.downloadFile(data, `backup-${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
                    this.showToast('å¤‡ä»½æˆåŠŸ');
                },
                
                async restoreData() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const text = await file.text();
                        try {
                            const backup = JSON.parse(text);
                            
                            if (!backup.data) {
                                throw new Error('Invalid backup file');
                            }
                            
                            // æ¸…ç©ºç°æœ‰æ•°æ®
                            await this.db.clear('phones');
                            await this.db.clear('accounts');
                            await this.db.clear('bills');
                            
                            // æ¢å¤æ•°æ®
                            for (const phone of backup.data.phones || []) {
                                await this.db.add('phones', phone);
                            }
                            for (const account of backup.data.accounts || []) {
                                await this.db.add('accounts', account);
                            }
                            for (const bill of backup.data.bills || []) {
                                await this.db.add('bills', bill);
                            }
                            
                            if (backup.data.settings) {
                                await this.db.update('settings', {
                                    key: 'general',
                                    value: backup.data.settings
                                });
                            }
                            
                            await this.loadData();
                            this.updateCharts();
                            this.showToast('æ¢å¤æˆåŠŸ');
                        } catch (error) {
                            this.showToast('æ¢å¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                        }
                    };
                    input.click();
                },
                
                async clearAllData() {
                    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
                    
                    await this.db.clear('phones');
                    await this.db.clear('accounts');
                    await this.db.clear('bills');
                    
                    this.phones = [];
                    this.accounts = [];
                    this.bills = [];
                    
                    this.updateCharts();
                    this.showToast('æ•°æ®å·²æ¸…ç©º');
                },
                
                // è®¾ç½®ç®¡ç†
                async saveSettings() {
                    await this.db.update('settings', {
                        key: 'general',
                        value: this.settings
                    });
                    this.showToast('è®¾ç½®å·²ä¿å­˜');
                },
                
                savePlatforms() {
                    this.platforms = this.platformList.split(',').map(p => p.trim()).filter(p => p);
                    this.showToast('å¹³å°åˆ—è¡¨å·²æ›´æ–°');
                },
                
                // æµ‹è¯•æ•°æ®ç”Ÿæˆï¼ˆæ‰¹é‡ä¼˜åŒ–ï¼‰
                async generateTestData() {
                    // ç”Ÿæˆæ‰‹æœºå·ç 
                    const carriers = ['ä¸­å›½ç§»åŠ¨', 'ä¸­å›½è”é€š', 'ä¸­å›½ç”µä¿¡'];
                    const packages = ['æ— é™æµé‡å¥—é¤', 'å•†åŠ¡å¥—é¤', 'é’æ˜¥å¥—é¤', '5Gç•…äº«å¥—é¤'];
                    const purposes = ['å®¢æœ', 'æ³¨å†Œ', 'è¥é”€', 'æµ‹è¯•', 'å¤‡ç”¨'];
                    const owners = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'é’±ä¸ƒ'];
                    
                    // æ‰¹é‡æ•°æ®æ•°ç»„
                    const phonesToAdd = [];
                    const accountsToAdd = [];
                    const billsToAdd = [];
                    
                    for (let i = 0; i < 20; i++) {
                        const phone = {
                            id: this.generateId(),
                            number: `138${String(Math.floor(Math.random() * 100000000)).padStart(8, '0')}`,
                            carrier: carriers[Math.floor(Math.random() * carriers.length)],
                            packageType: packages[Math.floor(Math.random() * packages.length)],
                            monthlyFee: Math.floor(Math.random() * 200) + 50,
                            status: Math.random() > 0.2 ? 'active' : (Math.random() > 0.5 ? 'inactive' : 'cancelled'),
                            purchaseDate: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().slice(0, 10),
                            owner: owners[Math.floor(Math.random() * owners.length)],
                            simLocation: `è®¾å¤‡${i + 1}`,
                            purpose: [purposes[Math.floor(Math.random() * purposes.length)]],
                            notes: `æµ‹è¯•å·ç ${i + 1}`,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        phonesToAdd.push(phone);
                        this.phones.push(phone);
                        
                        // ä¸ºæ´»è·ƒå·ç ç”Ÿæˆè´¦å·
                        if (phone.status === 'active') {
                            const accountCount = Math.floor(Math.random() * 3) + 2;
                            for (let j = 0; j < accountCount; j++) {
                                const account = {
                                    id: this.generateId(),
                                    phoneId: phone.id,
                                    platform: this.platforms[Math.floor(Math.random() * this.platforms.length)],
                                    accountName: `æµ‹è¯•è´¦å·${i}_${j}`,
                                    accountId: `test_${i}_${j}`,
                                    purpose: ['main', 'matrix', 'test'][Math.floor(Math.random() * 3)],
                                    status: Math.random() > 0.1 ? 'normal' : 'restricted',
                                    registerDate: phone.purchaseDate,
                                    lastLogin: new Date().toISOString().slice(0, 10),
                                    followers: Math.floor(Math.random() * 100000),
                                    notes: '',
                                    createdAt: new Date().toISOString()
                                };
                                
                                accountsToAdd.push(account);
                                this.accounts.push(account);
                            }
                        }
                        
                        // ç”Ÿæˆæœ€è¿‘6ä¸ªæœˆçš„è´¦å•
                        for (let m = 0; m < 6; m++) {
                            const date = new Date();
                            date.setMonth(date.getMonth() - m);
                            const yearMonth = date.toISOString().slice(0, 7);
                            
                            const bill = {
                                id: this.generateId(),
                                phoneId: phone.id,
                                yearMonth,
                                baseFee: phone.monthlyFee,
                                extraFee: Math.floor(Math.random() * 100),
                                totalFee: 0,
                                rechargeAmount: phone.monthlyFee + Math.floor(Math.random() * 200),
                                balance: Math.floor(Math.random() * 100) + 10,
                                details: {
                                    calls: Math.floor(Math.random() * 50),
                                    sms: Math.floor(Math.random() * 20),
                                    data: Math.floor(Math.random() * 30)
                                },
                                createdAt: new Date().toISOString()
                            };
                            
                            bill.totalFee = bill.baseFee + bill.extraFee;
                            
                            billsToAdd.push(bill);
                            this.bills.push(bill);
                        }
                    }
                    
                    // æ‰¹é‡æ•°æ®åº“æ“ä½œ
                    const transaction = this.db.db.transaction(['phones', 'accounts', 'bills'], 'readwrite');
                    const phoneStore = transaction.objectStore('phones');
                    const accountStore = transaction.objectStore('accounts');
                    const billStore = transaction.objectStore('bills');
                    
                    // æ‰¹é‡æ·»åŠ æ‰‹æœºå·ç 
                    for (const phone of phonesToAdd) {
                        phoneStore.add(phone);
                    }
                    
                    // æ‰¹é‡æ·»åŠ è´¦å·
                    for (const account of accountsToAdd) {
                        accountStore.add(account);
                    }
                    
                    // æ‰¹é‡æ·»åŠ è´¦å•
                    for (const bill of billsToAdd) {
                        billStore.add(bill);
                    }
                    
                    // ç­‰å¾…äº‹åŠ¡å®Œæˆ
                    await new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                    
                    this.buildMaps(); // é‡æ–°æ„å»ºç´¢å¼•
                    this.updateCharts();
                    this.showToast('æµ‹è¯•æ•°æ®ç”ŸæˆæˆåŠŸ');
                },
                
                // å·¥å…·æ–¹æ³•
                generateId() {
                    return Date.now().toString(36) + Math.random().toString(36).substr(2);
                },
                
                getPhoneNumber(phoneId) {
                    // ä½¿ç”¨Mapç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
                    const phone = this.phoneMap.get(phoneId);
                    return phone ? phone.number : 'æœªçŸ¥';
                },
                
                getPlatformColor(platform) {
                    const colors = {
                        'æŠ–éŸ³': 'background: #000',
                        'å¿«æ‰‹': 'background: #ff6100',
                        'å°çº¢ä¹¦': 'background: #ff2442',
                        'Bç«™': 'background: #00a1d6',
                        'è§†é¢‘å·': 'background: #07c160',
                        'çŸ¥ä¹': 'background: #0084ff',
                        'å¾®åš': 'background: #e6162d',
                        'ä»Šæ—¥å¤´æ¡': 'background: #ed4040'
                    };
                    return colors[platform] || 'background: #999';
                },
                
                showToast(message, type = 'success') {
                    // æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨é˜²æ­¢å†…å­˜æ³„æ¼
                    if (this.toastTimer) {
                        clearTimeout(this.toastTimer);
                    }
                    
                    this.toast = {
                        show: true,
                        message,
                        type
                    };
                    
                    this.toastTimer = setTimeout(() => {
                        this.toast.show = false;
                        this.toastTimer = null;
                    }, 3000);
                },
                
                downloadFile(content, filename, type) {
                    const blob = new Blob([content], { type });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                
                // æœç´¢é˜²æŠ–å¤„ç†
                debouncedSearch(event) {
                    // æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨
                    if (this.searchDebounceTimer) {
                        clearTimeout(this.searchDebounceTimer);
                    }
                    
                    // è®¾ç½®æ–°çš„é˜²æŠ–å®šæ—¶å™¨
                    this.searchDebounceTimer = setTimeout(() => {
                        this.phoneSearch = event.target.value;
                    }, 300);
                }
            },
            
            mounted() {
                this.init();
            },
            
            // ç”Ÿå‘½å‘¨æœŸé’©å­ - ç»„ä»¶é”€æ¯å‰æ¸…ç†èµ„æº
            beforeUnmount() {
                // æ¸…ç†å›¾è¡¨å®ä¾‹
                if (this.costChart) {
                    this.costChart.destroy();
                    this.costChart = null;
                }
                if (this.billChart) {
                    this.billChart.destroy();
                    this.billChart = null;
                }
                
                // æ¸…ç†å®šæ—¶å™¨
                if (this.toastTimer) {
                    clearTimeout(this.toastTimer);
                    this.toastTimer = null;
                }
                if (this.searchDebounceTimer) {
                    clearTimeout(this.searchDebounceTimer);
                    this.searchDebounceTimer = null;
                }
                
                // æ¸…ç†Map
                this.phoneMap.clear();
                this.accountsByPhoneMap.clear();
            }
        }).mount('#app');
    </script>
</body>
</html>