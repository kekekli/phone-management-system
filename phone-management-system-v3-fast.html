<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºå·ç ç®¡ç†ç³»ç»Ÿ v3.0 - å¿«é€Ÿå¯åŠ¨ç‰ˆ</title>
    
    <!-- é¢„è¿æ¥å’ŒDNSé¢„è§£æ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- å…³é”®CSSå†…è” -->
    <style>
        /* éª¨æ¶å±æ ·å¼ - å…³é”®CSS */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, transparent 63%, #f0f0f0 75%);
            background-size: 400% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* åŠ è½½è¿›åº¦æ¡ */
        .loading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(0,0,0,0.1);
            z-index: 9999;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* é¦–å±ä¼˜åŒ–CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .version-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #666;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            min-height: 600px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* éª¨æ¶å±å†…å®¹ */
        .skeleton-header {
            height: 60px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .skeleton-nav {
            height: 40px;
            width: 300px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .skeleton-content {
            height: 400px;
            border-radius: 8px;
        }

        /* ===== ç™»å½•ç•Œé¢æ ·å¼ ===== */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 24px;
            color: #333;
            margin: 0 0 10px 0;
            font-weight: 600;
        }

        .version-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .login-form {
            margin-bottom: 20px;
        }

        .form-group {
            position: relative;
            margin-bottom: 20px;
        }

        .form-group input {
            width: 100%;
            padding: 15px 45px 15px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            cursor: pointer;
            font-size: 18px;
        }

        .form-group .input-icon:hover {
            color: #667eea;
        }

        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            font-size: 14px;
        }

        .form-options label {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #666;
        }

        .form-options input[type="checkbox"] {
            margin-right: 8px;
        }

        .form-options a {
            color: #667eea;
            text-decoration: none;
        }

        .form-options a:hover {
            text-decoration: underline;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-footer {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .login-footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }

        /* é”™è¯¯æç¤º */
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            border: 1px solid #fcc;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* æˆåŠŸæç¤º */
        .success-message {
            background: #efe;
            color: #373;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            border: 1px solid #cfc;
        }

        /* éªŒè¯ç  */
        .captcha-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .captcha-container input {
            flex: 1;
        }

        .captcha-image {
            width: 120px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
            font-family: monospace;
            font-weight: bold;
            color: #666;
            user-select: none;
        }

        /* åŠ è½½çŠ¶æ€ */
        .login-loading {
            position: relative;
        }

        .login-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç™»å½•æˆåŠŸè¿‡æ¸¡ */
        .login-success {
            animation: fadeOut 0.5s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .login-card {
                padding: 30px 20px;
                margin: 10px;
                border-radius: 15px;
            }
            
            .login-header h1 {
                font-size: 20px;
            }
            
            .form-group input {
                padding: 12px 40px 12px 12px;
                font-size: 14px;
            }
            
            .login-btn {
                padding: 12px;
                font-size: 14px;
            }
        }

        /* éšè—ä¸»åº”ç”¨ */
        .app-hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½è¿›åº¦æ¡ -->
    <div class="loading-progress" id="loadingProgress">
        <div class="loading-progress-bar" id="loadingProgressBar"></div>
    </div>

    <div id="app">
        <!-- ç™»å½•ç•Œé¢ -->
        <div v-if="showLoginPage" class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1>æ‰‹æœºå·ç ç®¡ç†ç³»ç»Ÿ</h1>
                    <span class="version-badge">v3.0 å¿«é€Ÿå¯åŠ¨ç‰ˆ</span>
                </div>
                
                <!-- é”™è¯¯æç¤º -->
                <div v-if="loginError" class="error-message">
                    {{ loginError }}
                </div>
                
                <!-- æˆåŠŸæç¤º -->
                <div v-if="loginSuccess" class="success-message">
                    {{ loginSuccess }}
                </div>
                
                <form @submit.prevent="handleLogin" class="login-form">
                    <div class="form-group">
                        <input 
                            type="text" 
                            v-model="loginForm.username"
                            placeholder="ç”¨æˆ·å/æ‰‹æœºå·/é‚®ç®±"
                            required
                            :disabled="loginLoading">
                        <span class="input-icon">ğŸ‘¤</span>
                    </div>
                    
                    <div class="form-group">
                        <input 
                            :type="showPassword ? 'text' : 'password'"
                            v-model="loginForm.password"
                            placeholder="å¯†ç "
                            required
                            :disabled="loginLoading">
                        <span class="input-icon" @click="togglePassword">
                            {{ showPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸' }}
                        </span>
                    </div>
                    
                    <!-- éªŒè¯ç ï¼ˆå¤±è´¥3æ¬¡åæ˜¾ç¤ºï¼‰ -->
                    <div v-if="showCaptcha" class="form-group">
                        <div class="captcha-container">
                            <input 
                                type="text" 
                                v-model="loginForm.captcha"
                                placeholder="éªŒè¯ç "
                                required
                                :disabled="loginLoading">
                            <div class="captcha-image" @click="refreshCaptcha">
                                {{ captchaText }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-options">
                        <label>
                            <input type="checkbox" v-model="loginForm.rememberMe" :disabled="loginLoading">
                            è®°ä½æˆ‘
                        </label>
                        <a href="#" @click.prevent="showForgotPassword">å¿˜è®°å¯†ç ï¼Ÿ</a>
                    </div>
                    
                    <button 
                        type="submit" 
                        class="login-btn"
                        :class="{ 'login-loading': loginLoading }"
                        :disabled="loginLoading">
                        {{ loginLoading ? '' : 'ç™»å½•' }}
                    </button>
                </form>
                
                <div class="login-footer">
                    <p>è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ<a href="#" @click.prevent="showRegister">ç«‹å³æ³¨å†Œ</a></p>
                    <!-- <p style="margin-top: 10px;"><a href="#" @click.prevent="guestLogin">æ¸¸å®¢æ¨¡å¼</a></p> -->
                </div>
            </div>
        </div>

        <!-- éª¨æ¶å± -->
        <div v-if="isLoading" class="skeleton-container">
            <div class="skeleton skeleton-header"></div>
            <div class="skeleton skeleton-nav"></div>
            <div class="skeleton skeleton-content"></div>
        </div>

        <!-- å®é™…å†…å®¹ -->
        <div v-show="!isLoading && !showLoginPage">
            <!-- æ€§èƒ½æŒ‡ç¤ºå™¨ -->
            <div class="performance-indicator" v-if="showPerformance">
                <div class="performance-metric">
                    <span>æ•°æ®æ€»é‡:</span>
                    <span class="performance-value">{{ phones.length }}</span>
                </div>
                <div class="performance-metric">
                    <span>å¯è§é¡¹:</span>
                    <span class="performance-value">{{ visibleCount }}</span>
                </div>
                <div class="performance-metric">
                    <span>å†…å­˜ä¼˜åŒ–:</span>
                    <span class="performance-value">{{ memoryOptimization }}%</span>
                </div>
                <div class="performance-metric">
                    <span>FPS:</span>
                    <span class="performance-value">{{ currentFPS }}</span>
                </div>
                <div class="performance-metric">
                    <span>åŠ è½½æ—¶é—´:</span>
                    <span class="performance-value">{{ loadTime }}ms</span>
                </div>
            </div>

            <div class="header">
                <div>
                    <h1 style="display: inline-block;">æ‰‹æœºå·ç ç®¡ç†ç³»ç»Ÿ</h1>
                    <span class="version-badge" style="margin-left: 15px;">v3.0 å¿«é€Ÿå¯åŠ¨ç‰ˆ</span>
                </div>
                
                <!-- ç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’® -->
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #666; font-size: 14px;">
                        æ¬¢è¿ï¼Œ{{ currentUser ? currentUser.username : 'Guest' }}
                        <span v-if="currentUser && currentUser.role === 'admin'" style="color: #f5576c;">[ç®¡ç†å‘˜]</span>
                    </span>
                    <button 
                        class="btn btn-sm" 
                        style="background: #f5576c; color: white; border: none; padding: 5px 12px; border-radius: 4px;"
                        @click="logout">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
            
            <div class="header">
                <div class="nav-tabs">
                    <button class="nav-tab" :class="{active: currentTab === 'dashboard'}" @click="switchTab('dashboard')">
                        ä»ªè¡¨ç›˜
                    </button>
                    <button class="nav-tab" :class="{active: currentTab === 'phones'}" @click="switchTab('phones')">
                        å·ç ç®¡ç†
                    </button>
                    <button class="nav-tab" :class="{active: currentTab === 'accounts'}" @click="switchTab('accounts')">
                        è´¦å·å…³è”
                    </button>
                    <button class="nav-tab" :class="{active: currentTab === 'bills'}" @click="switchTab('bills')">
                        è´¹ç”¨ç»Ÿè®¡
                    </button>
                    <button class="nav-tab" :class="{active: currentTab === 'settings'}" @click="switchTab('settings')">
                        ç³»ç»Ÿè®¾ç½®
                    </button>
                </div>
            </div>

            <div class="main-content">
                <!-- ä»ªè¡¨ç›˜ -->
                <div v-if="currentTab === 'dashboard'" class="tabs-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>æ€»å·ç æ•°</h3>
                            <div class="value">{{ phones.length }}</div>
                            <div class="change">æ´»è·ƒ: {{ activePhones.length }}</div>
                        </div>
                        <div class="stat-card">
                            <h3>æœ¬æœˆè´¹ç”¨</h3>
                            <div class="value">Â¥{{ currentMonthCost.toFixed(2) }}</div>
                            <div class="change">{{ costTrend }}</div>
                        </div>
                        <div class="stat-card">
                            <h3>å…³è”è´¦å·</h3>
                            <div class="value">{{ accounts.length }}</div>
                            <div class="change">{{ platformCount }} ä¸ªå¹³å°</div>
                        </div>
                        <div class="stat-card quick-query-card">
                            <h3>å¿«é€ŸæŸ¥è¯¢</h3>
                            <div style="display: flex; gap: 10px; margin: 10px 0;">
                                <input type="text" placeholder="è¾“å…¥æ‰‹æœºå·" v-model="quickQueryPhone" 
                                       @keyup.enter="quickQuery"
                                       style="flex: 1; padding: 8px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; font-size: 12px; background: rgba(255,255,255,0.1); color: white;">
                                <button class="btn btn-sm" @click="quickQuery" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">æŸ¥è¯¢</button>
                            </div>
                            <div v-if="quickQueryResult" style="font-size: 11px; margin-top: 10px; line-height: 1.4;">
                                <div v-if="quickQueryResult.phoneStatus !== 'æœªæ‰¾åˆ°'">
                                    <div><strong>{{ quickQueryResult.phoneOwner }}</strong> ({{ quickQueryResult.phoneCarrier }})</div>
                                    <div>è´¦å·æ•°é‡: {{ quickQueryResult.accountCount }} (æ­£å¸¸: {{ quickQueryResult.normalAccountCount }})</div>
                                    <div>å¹³å°: {{ quickQueryResult.platforms.slice(0, 3).join(', ') }}{{ quickQueryResult.platforms.length > 3 ? '...' : '' }}</div>
                                    <div>çŠ¶æ€: {{ quickQueryResult.phoneStatus }} | æœˆè´¹: Â¥{{ quickQueryResult.monthlyFee }}</div>
                                </div>
                                <div v-else style="color: rgba(255,255,255,0.7);">
                                    {{ quickQueryResult.phoneStatus }}
                                </div>
                            </div>
                            <div v-else style="font-size: 11px; margin-top: 10px; color: rgba(255,255,255,0.7);">
                                è¾“å…¥æ‰‹æœºå·ç å¿«é€ŸæŸ¥çœ‹å…³è”è´¦å·ä¿¡æ¯
                            </div>
                        </div>
                    </div>

                    <h3 style="margin: 20px 0;">å¿«é€Ÿæ“ä½œ</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" @click="openPhoneModal()">æ·»åŠ å·ç </button>
                        <button class="btn btn-primary" @click="openBillModal()">å½•å…¥è´¦å•</button>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                            <h3 style="margin-bottom: 15px;">è´¹ç”¨è¶‹åŠ¿</h3>
                            <canvas id="costChart" style="height: 200px;" v-show="chartsLoaded"></canvas>
                            <div v-show="!chartsLoaded" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #666;">
                                å›¾è¡¨åŠ è½½ä¸­...
                            </div>
                        </div>
                        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                            <h3 style="margin-bottom: 15px;">è´¹ç”¨æ„æˆ</h3>
                            <canvas id="billChart" style="height: 200px;" v-show="chartsLoaded"></canvas>
                            <div v-show="!chartsLoaded" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #666;">
                                å›¾è¡¨åŠ è½½ä¸­...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å·ç ç®¡ç† - ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ -->
                <div v-if="currentTab === 'phones'" class="tabs-content">
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="æœç´¢å·ç ã€è¿è¥å•†ã€è´Ÿè´£äºº..." 
                               v-model="phoneSearch" @input="debouncedSearch">
                        <select class="search-input" style="width: 150px;" v-model="phoneFilter">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="active">åœ¨ç”¨</option>
                            <option value="inactive">åœç”¨</option>
                            <option value="cancelled">å·²é”€å·</option>
                        </select>
                        <button class="btn btn-primary" @click="openPhoneModal()">æ·»åŠ å·ç </button>
                        <button class="btn btn-primary" @click="loadMoreData" v-if="hasMoreData">
                            åŠ è½½æ›´å¤š ({{ remainingCount }} æ¡å‰©ä½™)
                        </button>
                    </div>

                    <!-- è™šæ‹Ÿæ»šåŠ¨å®¹å™¨ -->
                    <div class="virtual-scroll-container" @scroll="handleScroll" ref="scrollContainer">
                        <div class="virtual-scroll-spacer" :style="{ height: totalHeight + 'px' }">
                            <div class="virtual-scroll-items" :style="{ transform: `translateY(${offsetY}px)` }">
                                <div v-for="(phone, index) in visibleItems" 
                                     :key="phone.id" 
                                     class="virtual-item"
                                     :style="{ height: itemHeight + 'px' }">
                                    <div style="flex: 1; display: grid; grid-template-columns: 150px 100px 100px 120px 100px 100px auto; gap: 20px; align-items: center;">
                                        <strong>{{ phone.number }}</strong>
                                        <span>{{ phone.carrier }}</span>
                                        <span :style="{color: getStatusColor(phone.status)}">{{ statusText[phone.status] }}</span>
                                        <span>{{ phone.packageType }}</span>
                                        <span>Â¥{{ phone.monthlyFee }}</span>
                                        <span>{{ phone.owner }}</span>
                                        <div>
                                            <button class="btn btn-sm" @click="editPhone(phone)">ç¼–è¾‘</button>
                                            <button class="btn btn-sm" @click="deletePhone(phone.id)" style="margin-left: 5px;">åˆ é™¤</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 10px; text-align: center; color: #666; font-size: 14px;">
                        æ˜¾ç¤º {{ visibleStart + 1 }}-{{ Math.min(visibleEnd, filteredPhones.length) }} / å…± {{ filteredPhones.length }} æ¡ (å·²åŠ è½½ {{ loadedDataCount }} æ¡)
                    </div>
                </div>

                <!-- è´¦å·å…³è”å¢å¼ºç‰ˆ -->
                <div v-if="currentTab === 'accounts'" class="tabs-content">
                    <div class="enhanced-search-bar">
                        <!-- ç­›é€‰æ¨¡å¼é€‰æ‹© -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="filter-mode-btn" :class="{active: accountFilterMode === 'all'}" @click="setAccountFilterMode('all')">
                                æ˜¾ç¤ºå…¨éƒ¨è´¦å·
                            </button>
                            <button class="filter-mode-btn" :class="{active: accountFilterMode === 'phone'}" @click="setAccountFilterMode('phone')">
                                æŒ‰æ‰‹æœºå·ç­›é€‰
                            </button>
                            <button class="filter-mode-btn" :class="{active: accountFilterMode === 'platform'}" @click="setAccountFilterMode('platform')">
                                æŒ‰å¹³å°ç­›é€‰
                            </button>
                        </div>
                        
                        <!-- ç­›é€‰æ¡ä»¶ -->
                        <div class="search-bar">
                            <!-- æ‰‹æœºå·ç­›é€‰ -->
                            <select v-if="accountFilterMode === 'phone'" class="search-input" v-model="selectedPhoneForAccount">
                                <option value="">é€‰æ‹©æ‰‹æœºå·æŸ¥çœ‹å…³è”è´¦å·</option>
                                <option v-for="phone in activePhones" :key="phone.id" :value="phone.id">
                                    {{ phone.number }} - {{ phone.owner }}
                                </option>
                            </select>
                            
                            <!-- å¹³å°ç­›é€‰ -->
                            <select v-if="accountFilterMode === 'platform'" class="search-input" v-model="selectedPlatform">
                                <option value="">é€‰æ‹©å¹³å°</option>
                                <option v-for="platform in platforms" :key="platform" :value="platform">
                                    {{ platform }}
                                </option>
                            </select>
                            
                            <!-- å·ç æœç´¢æ¡† -->
                            <input type="text" class="search-input" placeholder="è¾“å…¥å·ç å¿«é€ŸæŸ¥æ‰¾" 
                                   v-model="accountPhoneSearch" style="flex: 1;">
                            
                            <button class="btn btn-primary" @click="openAccountModal()" 
                                    :disabled="accountFilterMode === 'phone' && !selectedPhoneForAccount">
                                æ·»åŠ è´¦å·
                            </button>
                        </div>
                    </div>

                    <!-- è´¦å·åˆ—è¡¨å±•ç¤º -->
                    <div v-if="displayedAccounts.length > 0" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div v-for="account in displayedAccounts" :key="account.id" 
                             class="account-card" :class="getPlatformClass(account.platform)">
                            <div class="account-header">
                                <h4>{{ account.accountName }}</h4>
                                <span class="platform-badge" :style="{backgroundColor: getPlatformColor(account.platform)}">
                                    {{ account.platform }}
                                </span>
                            </div>
                            <p style="color: #666; margin: 10px 0;">
                                <strong>æ‰‹æœºå·:</strong> {{ getPhoneNumber(account.phoneId) }}<br>
                                <strong>è´¦å·ID:</strong> {{ account.accountId || 'æœªè®¾ç½®' }}<br>
                                <strong>ç”¨é€”:</strong> {{ account.purpose }}<br>
                                <strong>çŠ¶æ€:</strong> <span :style="{color: getAccountStatusColor(account.status)}">
                                    {{ accountStatusText[account.status] }}
                                </span><br>
                                <strong>ç²‰ä¸æ•°:</strong> {{ account.followers || 0 }}
                            </p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-sm" @click="editAccount(account)">ç¼–è¾‘</button>
                                <button class="btn btn-sm" @click="deleteAccount(account.id)" style="margin-left: 5px;">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç©ºçŠ¶æ€æ˜¾ç¤º -->
                    <div v-else style="text-align: center; padding: 50px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“±</div>
                        <h3>æš‚æ— è´¦å·æ•°æ®</h3>
                        <p>è¯·æ·»åŠ è´¦å·æˆ–è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
                    </div>
                </div>

                <!-- è´¹ç”¨ç»Ÿè®¡ -->
                <div v-if="currentTab === 'bills'" class="tabs-content">
                    <div class="search-bar">
                        <input type="month" class="search-input" v-model="selectedMonth">
                        <button class="btn btn-primary" @click="openBillModal()">å½•å…¥è´¦å•</button>
                        <button class="btn btn-primary" @click="exportBillReport">å¯¼å‡ºæŠ¥è¡¨</button>
                    </div>

                    <div style="margin-top: 20px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9f9f9;">
                                    <th style="padding: 12px; text-align: left;">æ‰‹æœºå·</th>
                                    <th style="padding: 12px; text-align: left;">è´¦å•æœˆä»½</th>
                                    <th style="padding: 12px; text-align: left;">åŸºç¡€è´¹ç”¨</th>
                                    <th style="padding: 12px; text-align: left;">é¢å¤–è´¹ç”¨</th>
                                    <th style="padding: 12px; text-align: left;">æ€»è´¹ç”¨</th>
                                    <th style="padding: 12px; text-align: left;">å……å€¼é‡‘é¢</th>
                                    <th style="padding: 12px; text-align: left;">å½“å‰ä½™é¢</th>
                                    <th style="padding: 12px; text-align: left;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="bill in filteredBills" :key="bill.id" style="border-bottom: 1px solid #e5e5e5;">
                                    <td style="padding: 12px;">{{ getPhoneNumber(bill.phoneId) }}</td>
                                    <td style="padding: 12px;">{{ bill.yearMonth }}</td>
                                    <td style="padding: 12px;">Â¥{{ bill.baseFee }}</td>
                                    <td style="padding: 12px;">Â¥{{ bill.extraFee }}</td>
                                    <td style="padding: 12px;"><strong>Â¥{{ bill.totalFee }}</strong></td>
                                    <td style="padding: 12px;">Â¥{{ bill.rechargeAmount }}</td>
                                    <td style="padding: 12px;">Â¥{{ bill.balance }}</td>
                                    <td style="padding: 12px;">
                                        <button class="btn btn-sm" @click="editBill(bill)">ç¼–è¾‘</button>
                                        <button class="btn btn-sm" @click="deleteBill(bill.id)" style="margin-left: 5px;">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ç³»ç»Ÿè®¾ç½® -->
                <div v-if="currentTab === 'settings'" class="tabs-content">
                    <h3>æ•°æ®ç®¡ç†</h3>
                    <div style="display: flex; gap: 10px; margin: 20px 0;">
                        <button class="btn btn-primary" @click="backupData">å¤‡ä»½æ•°æ®</button>
                        <button class="btn btn-primary" @click="restoreData">æ¢å¤æ•°æ®</button>
                        <button class="btn btn-primary" @click="clearData" style="background: #f44336;">æ¸…ç©ºæ•°æ®</button>
                    </div>

                    <h3 style="margin-top: 30px;">å¯¼å…¥å¯¼å‡º</h3>
                    <div style="display: flex; gap: 10px; margin: 20px 0;">
                        <button class="btn btn-primary" @click="importPhones">å¯¼å…¥å·ç </button>
                        <button class="btn btn-primary" @click="exportPhones">å¯¼å‡ºå·ç </button>
                        <button class="btn btn-primary" @click="importBills">å¯¼å…¥è´¦å•</button>
                    </div>

                    <!-- æ€§èƒ½ä¼˜åŒ–è¯´æ˜å·²éšè— -->
                </div>
            </div>

            <!-- æ‰‹æœºå·ç¼–è¾‘æ¨¡æ€æ¡† -->
            <div class="modal" :class="{show: showPhoneModal}">
                <div class="modal-content">
                    <h2>{{ editingPhone ? 'ç¼–è¾‘æ‰‹æœºå·' : 'æ·»åŠ æ‰‹æœºå·' }}</h2>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">æ‰‹æœºå·ç </label>
                        <input type="text" v-model="phoneForm.number" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">è¿è¥å•†</label>
                        <select v-model="phoneForm.carrier" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option>ä¸­å›½ç§»åŠ¨</option>
                            <option>ä¸­å›½è”é€š</option>
                            <option>ä¸­å›½ç”µä¿¡</option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">çŠ¶æ€</label>
                        <select v-model="phoneForm.status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="active">åœ¨ç”¨</option>
                            <option value="inactive">åœç”¨</option>
                            <option value="cancelled">å·²é”€å·</option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">å¥—é¤ç±»å‹</label>
                        <input type="text" v-model="phoneForm.packageType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">æœˆè´¹(å…ƒ)</label>
                        <input type="number" v-model="phoneForm.monthlyFee" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">è´Ÿè´£äºº</label>
                        <input type="text" v-model="phoneForm.owner" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn" @click="closePhoneModal">å–æ¶ˆ</button>
                        <button class="btn btn-primary" @click="savePhone">ä¿å­˜</button>
                    </div>
                </div>
            </div>
            
            <!-- è´¦å·ç¼–è¾‘æ¨¡æ€æ¡† -->
            <div class="modal" :class="{show: showAccountModal}">
                <div class="modal-content">
                    <h2>{{ editingAccount ? 'ç¼–è¾‘è´¦å·' : 'æ·»åŠ è´¦å·' }}</h2>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">å…³è”æ‰‹æœºå·</label>
                        <select v-model="accountForm.phoneId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">é€‰æ‹©æ‰‹æœºå·</option>
                            <option v-for="phone in activePhones" :key="phone.id" :value="phone.id">
                                {{ phone.number }} - {{ phone.owner }}
                            </option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">å¹³å°</label>
                        <select v-model="accountForm.platform" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option v-for="platform in platforms" :key="platform" :value="platform">
                                {{ platform }}
                            </option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">è´¦å·åç§°</label>
                        <input type="text" v-model="accountForm.accountName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">è´¦å·IDï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" v-model="accountForm.accountId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">ç”¨é€”</label>
                        <select v-model="accountForm.purpose" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="main">ä¸»è´¦å·</option>
                            <option value="backup">å¤‡ç”¨è´¦å·</option>
                            <option value="test">æµ‹è¯•è´¦å·</option>
                            <option value="business">å•†ç”¨è´¦å·</option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">çŠ¶æ€</label>
                        <select v-model="accountForm.status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="normal">æ­£å¸¸</option>
                            <option value="restricted">å—é™</option>
                            <option value="banned">å°ç¦</option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">ç²‰ä¸æ•°</label>
                        <input type="number" v-model="accountForm.followers" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">å¤‡æ³¨</label>
                        <textarea v-model="accountForm.notes" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 80px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn" @click="closeAccountModal">å–æ¶ˆ</button>
                        <button class="btn btn-primary" @click="saveAccount">ä¿å­˜</button>
                    </div>
                </div>
            </div>
            
            <!-- è´¦å•ç¼–è¾‘æ¨¡æ€æ¡† -->
            <div class="modal" :class="{show: showBillModal}">
                <div class="modal-content">
                    <h2>{{ editingBill ? 'ç¼–è¾‘è´¦å•' : 'å½•å…¥è´¦å•' }}</h2>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">æ‰‹æœºå·</label>
                        <select v-model="billForm.phoneId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">é€‰æ‹©æ‰‹æœºå·</option>
                            <option v-for="phone in phones" :key="phone.id" :value="phone.id">
                                {{ phone.number }} - {{ phone.owner }}
                            </option>
                        </select>
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">è´¦å•æœˆä»½</label>
                        <input type="month" v-model="billForm.yearMonth" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">åŸºç¡€è´¹ç”¨(å…ƒ)</label>
                        <input type="number" v-model="billForm.baseFee" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">é¢å¤–è´¹ç”¨(å…ƒ)</label>
                        <input type="number" v-model="billForm.extraFee" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">å……å€¼é‡‘é¢(å…ƒ)</label>
                        <input type="number" v-model="billForm.rechargeAmount" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px;">å½“å‰ä½™é¢(å…ƒ)</label>
                        <input type="number" v-model="billForm.balance" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 4px;">
                        <strong>æ€»è´¹ç”¨: Â¥{{ (parseFloat(billForm.baseFee) + parseFloat(billForm.extraFee)).toFixed(2) }}</strong>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn" @click="closeBillModal">å–æ¶ˆ</button>
                        <button class="btn btn-primary" @click="saveBill">ä¿å­˜</button>
                    </div>
                </div>
            </div>

            <!-- Toastæç¤º -->
            <div v-if="toast.show" class="toast" :class="toast.type">
                {{ toast.message }}
            </div>
        </div>
    </div>

    <!-- å»¶è¿ŸåŠ è½½å®Œæ•´CSS -->
    <link rel="preload" href="data:text/css;base64," as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="data:text/css;base64,"></noscript>

    <!-- æœ¬åœ°JSåº“ -->
    <script src="./libs/vue.global.prod.js"></script>

    <script>
        // Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful');
                })
                .catch(function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        const { createApp } = Vue;

        // åŠ è½½è¿›åº¦ç®¡ç†
        class LoadingManager {
            constructor() {
                this.progress = 0;
                this.steps = ['åˆå§‹åŒ–åº”ç”¨', 'åŠ è½½æ•°æ®åº“', 'æ„å»ºç´¢å¼•', 'æ¸²æŸ“ç•Œé¢', 'åŠ è½½å®Œæˆ'];
                this.currentStep = 0;
                this.progressBar = document.getElementById('loadingProgressBar');
                this.progressContainer = document.getElementById('loadingProgress');
            }

            updateProgress(percent, step) {
                this.progress = Math.min(percent, 100);
                this.progressBar.style.width = this.progress + '%';
                
                if (step !== undefined) {
                    this.currentStep = step;
                    console.log(`åŠ è½½è¿›åº¦: ${this.progress}% - ${this.steps[this.currentStep] || 'åŠ è½½ä¸­'}`);
                }

                if (this.progress >= 100) {
                    setTimeout(() => {
                        this.hide();
                    }, 300);
                }
            }

            hide() {
                this.progressContainer.style.opacity = '0';
                setTimeout(() => {
                    this.progressContainer.style.display = 'none';
                }, 300);
            }
        }

        // IndexedDBå·¥å…·ç±»
        // æ›¿æ¢åŸæœ‰çš„ Database ç±»ä¸º RemoteDatabase
        class RemoteDatabase {
            constructor() {
                // æ™ºèƒ½åˆ¤æ–­APIåœ°å€
                this.apiUrl = this.getApiUrl();
                
                console.log('ğŸŒ APIæœåŠ¡å™¨åœ°å€:', this.apiUrl);
                
                // è·å–ä¿å­˜çš„token
                this.token = sessionStorage.getItem('authToken') || localStorage.getItem('authToken');
            }
            
            getApiUrl() {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                
                // ç”Ÿäº§ç¯å¢ƒåœ°å€ (éœ€è¦éƒ¨ç½²æ—¶æ›´æ–°)
                const PRODUCTION_API_URL = 'https://YOUR-APP-NAME.railway.app/api';
                
                // æœ¬åœ°å¼€å‘ç¯å¢ƒ
                const LOCAL_API_URL = 'http://localhost:5001/api';
                
                // åˆ¤æ–­è¿è¡Œç¯å¢ƒ
                if (protocol === 'file:' || 
                    hostname === 'localhost' || 
                    hostname === '127.0.0.1' ||
                    hostname.includes('localhost') ||
                    hostname.includes('127.0.0.1')) {
                    return LOCAL_API_URL;
                }
                
                // ç”Ÿäº§ç¯å¢ƒ - å¦‚æœåŸŸååŒ…å«ç‰¹å®šå…³é”®è¯
                if (hostname.includes('railway.app') || 
                    hostname.includes('pages.dev') ||
                    hostname.includes('vercel.app') ||
                    hostname.includes('netlify.app')) {
                    return PRODUCTION_API_URL;
                }
                
                // é»˜è®¤ä½¿ç”¨å½“å‰åŸŸåçš„API
                const port = window.location.port;
                if (port && port !== '80' && port !== '443') {
                    return `${protocol}//${hostname}:5001/api`;
                } else {
                    return `${protocol}//${hostname}/api`;
                }
            }
            
            // è®¾ç½®è®¤è¯token
            setToken(token) {
                this.token = token;
                sessionStorage.setItem('authToken', token);
            }
            
            // æ¸…é™¤token
            clearToken() {
                this.token = null;
                sessionStorage.removeItem('authToken');
                localStorage.removeItem('authToken');
            }
            
            // é€šç”¨è¯·æ±‚æ–¹æ³•
            async request(url, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                // æ·»åŠ è®¤è¯å¤´
                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }
                
                try {
                    const response = await fetch(`${this.apiUrl}${url}`, {
                        ...options,
                        headers
                    });
                    
                    if (response.status === 401) {
                        // tokenè¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
                        this.clearToken();
                        // è§¦å‘é‡æ–°ç™»å½•
                        window.location.reload();
                        throw new Error('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    }
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'è¯·æ±‚å¤±è´¥');
                    }
                    
                    if (response.status === 204) {
                        return null; // åˆ é™¤æ“ä½œæˆåŠŸ
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('APIè¯·æ±‚å¤±è´¥:', error);
                    throw error;
                }
            }
            
            // ç™»å½•
            async login(username, password) {
                const response = await fetch(`${this.apiUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.setToken(data.token);
                }
                
                return data;
            }
            
            // æ¨¡æ‹ŸIndexedDBçš„initæ–¹æ³•
            async init() {
                // æµ‹è¯•è¿æ¥
                try {
                    const response = await fetch(`${this.apiUrl}/health`);
                    const data = await response.json();
                    console.log('æœåŠ¡å™¨è¿æ¥æˆåŠŸ:', data);
                    return true;
                } catch (error) {
                    console.error('æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                    throw new Error('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                }
            }
            
            // è·å–æ‰€æœ‰æ•°æ®
            async getAll(storeName) {
                const mapping = {
                    'phones': '/phones',
                    'accounts': '/accounts',
                    'bills': '/bills',
                    'users': '/users',
                    'settings': '/settings'
                };
                
                const endpoint = mapping[storeName];
                if (!endpoint) {
                    console.warn('æœªçŸ¥çš„å­˜å‚¨åç§°:', storeName);
                    return [];
                }
                
                try {
                    const result = await this.request(endpoint);
                    // ç¡®ä¿è¿”å›çš„æ˜¯æ•°ç»„
                    return Array.isArray(result) ? result : [];
                } catch (error) {
                    console.error(`è·å–${storeName}æ•°æ®å¤±è´¥:`, error);
                    return [];
                }
            }
            
            // æ·»åŠ æ•°æ®
            async add(storeName, data) {
                const mapping = {
                    'phones': '/phones',
                    'accounts': '/accounts',
                    'bills': '/bills'
                };
                
                const endpoint = mapping[storeName];
                if (!endpoint) {
                    throw new Error('ä¸æ”¯æŒçš„æ“ä½œ');
                }
                
                const result = await this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                return result.id || data.id;
            }
            
            // æ›´æ–°æ•°æ®
            async update(storeName, data) {
                const mapping = {
                    'phones': '/phones',
                    'accounts': '/accounts',
                    'bills': '/bills'
                };
                
                const endpoint = mapping[storeName];
                if (!endpoint) {
                    throw new Error('ä¸æ”¯æŒçš„æ“ä½œ');
                }
                
                return await this.request(`${endpoint}/${data.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }
            
            // åˆ é™¤æ•°æ®
            async delete(storeName, id) {
                const mapping = {
                    'phones': '/phones',
                    'accounts': '/accounts',
                    'bills': '/bills'
                };
                
                const endpoint = mapping[storeName];
                if (!endpoint) {
                    throw new Error('ä¸æ”¯æŒçš„æ“ä½œ');
                }
                
                return await this.request(`${endpoint}/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // è·å–å•ä¸ªæ•°æ®ï¼ˆå…¼å®¹æ–¹æ³•ï¼‰
            async get(storeName, id) {
                try {
                    const allData = await this.getAll(storeName);
                    // ç¡®ä¿ allData æ˜¯æ•°ç»„
                    if (Array.isArray(allData)) {
                        return allData.find(item => item.id === id);
                    } else {
                        console.warn('æ•°æ®æ ¼å¼é”™è¯¯ï¼ŒæœŸæœ›æ•°ç»„:', allData);
                        return null;
                    }
                } catch (error) {
                    console.error('è·å–å•ä¸ªæ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }
            
            // æ¸…ç©ºæ•°æ®ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
            async clear(storeName) {
                // æ¸…ç©ºæŒ‡å®šé›†åˆçš„æ‰€æœ‰æ•°æ®ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
                console.log(`æ­£åœ¨æ¸…ç©º ${storeName} æ•°æ®...`);
                
                try {
                    const response = await this.request(`/${storeName}/clear`, {
                        method: 'DELETE'
                    });
                    
                    console.log(`æˆåŠŸæ¸…ç©º ${storeName}:`, response);
                    return true;
                } catch (error) {
                    console.error(`æ¸…ç©º ${storeName} å¤±è´¥:`, error);
                    return false;
                }
            }
        }

        // åº”ç”¨å®ä¾‹
        const app = createApp({
            data() {
                return {
                    // ç™»å½•çŠ¶æ€
                    showLoginPage: true,
                    isLoggedIn: false,
                    currentUser: null,
                    
                    // ç™»å½•è¡¨å•
                    loginForm: {
                        username: '',
                        password: '',
                        captcha: '',
                        rememberMe: false
                    },
                    
                    // ç™»å½•ç•Œé¢çŠ¶æ€
                    loginLoading: false,
                    loginError: '',
                    loginSuccess: '',
                    showPassword: false,
                    showCaptcha: false,
                    captchaText: '',
                    loginFailCount: 0,
                    
                    // åŠ è½½çŠ¶æ€
                    isLoading: true,
                    chartsLoaded: false,
                    loadingManager: new LoadingManager(),
                    startTime: Date.now(),
                    loadTime: 0,
                    
                    // æ•°æ®åº“ - ä½¿ç”¨è¿œç¨‹æ•°æ®åº“æ›¿æ¢æœ¬åœ°æ•°æ®åº“
                    db: new RemoteDatabase(),
                    
                    // åˆ†æ‰¹åŠ è½½
                    batchSize: 50,
                    loadedDataCount: 0,
                    totalDataCount: 0,
                    hasMoreData: true,
                    remainingCount: 0,
                    
                    // è™šæ‹Ÿæ»šåŠ¨ç›¸å…³
                    itemHeight: 50,
                    containerHeight: 600,
                    scrollTop: 0,
                    visibleStart: 0,
                    visibleEnd: 20,
                    visibleCount: 20,
                    bufferSize: 5,
                    
                    // æ€§èƒ½ç›‘æ§
                    showPerformance: false,
                    currentFPS: 60,
                    memoryOptimization: 0,
                    fpsInterval: null,
                    lastFrameTime: Date.now(),
                    
                    // é¡µé¢çŠ¶æ€
                    currentTab: 'dashboard',
                    
                    // æ•°æ®
                    phones: [],
                    accounts: [],
                    bills: [],
                    settings: {},
                    platforms: ['æŠ–éŸ³', 'å¿«æ‰‹', 'å°çº¢ä¹¦', 'Bç«™', 'è§†é¢‘å·', 'çŸ¥ä¹', 'å¾®åš', 'ä»Šæ—¥å¤´æ¡', 'YouTube', 'TikTok'],
                    platformList: '',
                    
                    // è´¦å·å…³è”å¢å¼º
                    accountFilterMode: 'phone', // 'all', 'phone', 'platform'
                    selectedPlatform: '',
                    accountPhoneSearch: '',
                    
                    // å¿«é€ŸæŸ¥è¯¢
                    quickQueryPhone: '',
                    quickQueryResult: null,
                    
                    // Mapç´¢å¼•
                    phoneMap: new Map(),
                    accountsByPhoneMap: new Map(),
                    
                    // æœç´¢å’Œç­›é€‰
                    phoneSearch: '',
                    debouncedPhoneSearch: '',
                    phoneFilter: '',
                    selectedPhoneForAccount: '',
                    selectedMonth: new Date().toISOString().slice(0, 7),
                    
                    // é˜²æŠ–å®šæ—¶å™¨
                    searchDebounceTimer: null,
                    toastTimer: null,
                    
                    // æ¨¡æ€æ¡†
                    showPhoneModal: false,
                    showAccountModal: false,
                    showBillModal: false,
                    
                    // è¡¨å•
                    phoneForm: this.getEmptyPhoneForm(),
                    accountForm: this.getEmptyAccountForm(),
                    billForm: this.getEmptyBillForm(),
                    
                    // ç¼–è¾‘çŠ¶æ€
                    editingPhone: null,
                    editingAccount: null,
                    editingBill: null,
                    
                    // Toastæç¤º
                    toast: {
                        show: false,
                        message: '',
                        type: 'success'
                    },
                    
                    // å›¾è¡¨
                    costChart: null,
                    billChart: null,
                    chartLibLoaded: false,
                    
                    // çŠ¶æ€æ–‡æœ¬æ˜ å°„
                    statusText: {
                        active: 'åœ¨ç”¨',
                        inactive: 'åœç”¨',
                        cancelled: 'å·²é”€å·'
                    },
                    accountStatusText: {
                        normal: 'æ­£å¸¸',
                        restricted: 'å—é™',
                        banned: 'å°ç¦'
                    }
                };
            },

            computed: {
                // è™šæ‹Ÿæ»šåŠ¨ç›¸å…³è®¡ç®—
                totalHeight() {
                    return this.filteredPhones.length * this.itemHeight;
                },
                
                offsetY() {
                    return Math.max(0, this.visibleStart - this.bufferSize) * this.itemHeight;
                },
                
                visibleItems() {
                    const start = Math.max(0, this.visibleStart - this.bufferSize);
                    const end = Math.min(this.filteredPhones.length, this.visibleEnd + this.bufferSize);
                    return this.filteredPhones.slice(start, end);
                },
                
                // è¿‡æ»¤åçš„æ‰‹æœºå·åˆ—è¡¨ï¼ˆä½¿ç”¨é˜²æŠ–åçš„æœç´¢å€¼ï¼‰
                filteredPhones() {
                    return this.phones.filter(phone => {
                        const matchSearch = !this.debouncedPhoneSearch || 
                            phone.number.includes(this.debouncedPhoneSearch) ||
                            phone.carrier.includes(this.debouncedPhoneSearch) ||
                            phone.owner.includes(this.debouncedPhoneSearch);
                        const matchFilter = !this.phoneFilter || phone.status === this.phoneFilter;
                        return matchSearch && matchFilter;
                    });
                },
                
                activePhones() {
                    return this.phones.filter(p => p.status === 'active');
                },
                
                // ä½¿ç”¨Mapä¼˜åŒ–çš„è´¦å·è¿‡æ»¤
                filteredAccounts() {
                    if (this.selectedPhoneForAccount && this.accountsByPhoneMap.has(this.selectedPhoneForAccount)) {
                        return this.accountsByPhoneMap.get(this.selectedPhoneForAccount);
                    }
                    return [];
                },
                
                // å¢å¼ºçš„è´¦å·æ˜¾ç¤ºé€»è¾‘
                displayedAccounts() {
                    let accounts = [];
                    
                    switch (this.accountFilterMode) {
                        case 'all':
                            accounts = this.accounts;
                            break;
                        case 'phone':
                            accounts = this.filteredAccounts;
                            break;
                        case 'platform':
                            accounts = this.selectedPlatform ? 
                                this.accounts.filter(acc => acc.platform === this.selectedPlatform) : 
                                this.accounts;
                            break;
                        default:
                            accounts = this.accounts;
                    }
                    
                    // æŒ‰å·ç æœç´¢è¿‡æ»¤
                    if (this.accountPhoneSearch.trim()) {
                        const searchTerm = this.accountPhoneSearch.trim();
                        accounts = accounts.filter(acc => {
                            const phone = this.phoneMap.get(acc.phoneId);
                            return phone && phone.number.includes(searchTerm);
                        });
                    }
                    
                    return accounts;
                },
                
                filteredBills() {
                    return this.bills.filter(b => b.yearMonth === this.selectedMonth);
                },
                
                currentMonthCost() {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    return this.bills
                        .filter(b => b.yearMonth === currentMonth)
                        .reduce((sum, b) => sum + b.totalFee, 0);
                },
                
                costTrend() {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const lastMonth = new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString().slice(0, 7);
                    
                    const current = this.bills.filter(b => b.yearMonth === currentMonth).reduce((sum, b) => sum + b.totalFee, 0);
                    const last = this.bills.filter(b => b.yearMonth === lastMonth).reduce((sum, b) => sum + b.totalFee, 0);
                    
                    if (last === 0) return 'æ–°å¢';
                    const change = ((current - last) / last * 100).toFixed(1);
                    return change > 0 ? `â†‘${change}%` : `â†“${Math.abs(change)}%`;
                },
                
                platformCount() {
                    return new Set(this.accounts.map(a => a.platform)).size;
                },
                
                monthlyBaseFee() {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    return this.bills
                        .filter(b => b.yearMonth === currentMonth)
                        .reduce((sum, b) => sum + b.baseFee, 0);
                },
                
                monthlyExtraFee() {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    return this.bills
                        .filter(b => b.yearMonth === currentMonth)
                        .reduce((sum, b) => sum + b.extraFee, 0);
                }
            },

            methods: {
                // ===== ç™»å½•ç›¸å…³æ–¹æ³• =====
                
                // å¯†ç åŠ å¯†
                hashPassword(password) {
                    // ç®€å•çš„hashå®ç°
                    return btoa(password + 'PhoneManagementSalt2024');
                },
                
                // ç”ŸæˆéªŒè¯ç 
                generateCaptcha() {
                    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    let result = '';
                    for (let i = 0; i < 4; i++) {
                        result += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    this.captchaText = result;
                    return result;
                },
                
                // åˆ·æ–°éªŒè¯ç 
                refreshCaptcha() {
                    this.generateCaptcha();
                    this.loginForm.captcha = '';
                },
                
                // åˆ‡æ¢å¯†ç æ˜¾ç¤º
                togglePassword() {
                    this.showPassword = !this.showPassword;
                },
                
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                async checkLoginStatus() {
                    try {
                        // æ£€æŸ¥ä¼šè¯å­˜å‚¨
                        const sessionUser = sessionStorage.getItem('currentUser');
                        if (sessionUser) {
                            this.currentUser = JSON.parse(sessionUser);
                            this.isLoggedIn = true;
                            this.showLoginPage = false;
                            return true;
                        }
                        
                        // æ£€æŸ¥è®°ä½æˆ‘åŠŸèƒ½
                        const savedUser = localStorage.getItem('rememberedUser');
                        if (savedUser) {
                            const userData = JSON.parse(savedUser);
                            const user = await this.getUserByUsername(userData.username);
                            if (user && user.password === userData.password) {
                                this.currentUser = user;
                                this.isLoggedIn = true;
                                this.showLoginPage = false;
                                sessionStorage.setItem('currentUser', JSON.stringify(user));
                                return true;
                            } else {
                                // æ¸…é™¤æ— æ•ˆçš„è®°ä½æˆ‘æ•°æ®
                                localStorage.removeItem('rememberedUser');
                            }
                        }
                        
                        return false;
                    } catch (error) {
                        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                        return false;
                    }
                },
                
                // æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·
                async getUserByUsername(username) {
                    try {
                        const users = await this.db.getAll('users');
                        return users.find(u => 
                            u.username === username || 
                            u.email === username || 
                            u.phone === username
                        );
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·å¤±è´¥:', error);
                        return null;
                    }
                },
                
                // åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
                async createDefaultAdmin() {
                    try {
                        const existingAdmin = await this.getUserByUsername('admin');
                        if (!existingAdmin) {
                            const defaultAdmin = {
                                username: 'admin',
                                password: this.hashPassword('admin123'),
                                email: 'admin@example.com',
                                phone: '13800138000',
                                role: 'admin',
                                createdAt: new Date().toISOString(),
                                lastLogin: null,
                                loginCount: 0,
                                settings: {
                                    theme: 'default',
                                    rememberMe: true,
                                    autoLock: false
                                }
                            };
                            await this.db.add('users', defaultAdmin);
                            console.log('é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºæˆåŠŸ');
                        }
                    } catch (error) {
                        console.error('åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·å¤±è´¥:', error);
                    }
                },
                
                // è®°å½•ç™»å½•æ—¥å¿—
                async logLogin(userId, success, failReason = null) {
                    try {
                        const loginLog = {
                            userId: userId,
                            loginTime: new Date().toISOString(),
                            loginIp: 'local',
                            userAgent: navigator.userAgent,
                            success: success,
                            failReason: failReason
                        };
                        await this.db.add('loginLogs', loginLog);
                    } catch (error) {
                        console.error('è®°å½•ç™»å½•æ—¥å¿—å¤±è´¥:', error);
                    }
                },
                
                // å¤„ç†ç™»å½•
                async handleLogin() {
                    this.loginError = '';
                    this.loginSuccess = '';
                    
                    if (!this.loginForm.username || !this.loginForm.password) {
                        this.loginError = 'è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ';
                        return;
                    }
                    
                    this.loginLoading = true;
                    
                    try {
                        // ä½¿ç”¨APIç™»å½•
                        const result = await this.db.login(
                            this.loginForm.username,
                            this.loginForm.password
                        );
                        
                        if (result.success) {
                            this.currentUser = result.user;
                            this.isLoggedIn = true;
                            this.loginSuccess = 'ç™»å½•æˆåŠŸï¼';
                            
                            // è®°ä½æˆ‘åŠŸèƒ½
                            if (this.loginForm.rememberMe) {
                                localStorage.setItem('authToken', result.token);
                            }
                            
                            setTimeout(() => {
                                this.showLoginPage = false;
                                this.initApp();
                            }, 1000);
                        } else {
                            this.loginError = result.message || 'ç™»å½•å¤±è´¥';
                        }
                    } catch (error) {
                        this.loginError = error.message || 'ç™»å½•å¤±è´¥';
                    } finally {
                        this.loginLoading = false;
                    }
                },
                
                // ç™»å‡º
                async logout() {
                    this.isLoggedIn = false;
                    this.currentUser = null;
                    this.showLoginPage = true;
                    
                    // æ¸…é™¤ä¼šè¯
                    sessionStorage.removeItem('currentUser');
                    
                    // é‡ç½®ç™»å½•è¡¨å•
                    this.loginForm = {
                        username: '',
                        password: '',
                        captcha: '',
                        rememberMe: false
                    };
                    this.loginError = '';
                    this.loginSuccess = '';
                    this.showPassword = false;
                    this.showCaptcha = false;
                    this.loginFailCount = 0;
                },
                
                // å¿˜è®°å¯†ç 
                showForgotPassword() {
                    alert('å¿˜è®°å¯†ç åŠŸèƒ½å¼€å‘ä¸­...\n\næç¤ºï¼šé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·\nç”¨æˆ·å: admin\nå¯†ç : admin123');
                },
                
                // æ˜¾ç¤ºæ³¨å†Œ
                showRegister() {
                    alert('æ³¨å†ŒåŠŸèƒ½å¼€å‘ä¸­...\n\næç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·\nç”¨æˆ·å: admin\nå¯†ç : admin123');
                },
                
                // æ¸¸å®¢æ¨¡å¼
                async guestLogin() {
                    this.loginLoading = true;
                    this.loginSuccess = 'æ­£åœ¨ä»¥æ¸¸å®¢æ¨¡å¼ç™»å½•...';
                    
                    // åˆ›å»ºæ¸¸å®¢ç”¨æˆ·
                    const guestUser = {
                        id: 'guest_' + Date.now(),
                        username: 'guest',
                        role: 'user',
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        loginCount: 1
                    };
                    
                    this.currentUser = guestUser;
                    this.isLoggedIn = true;
                    
                    setTimeout(() => {
                        this.showLoginPage = false;
                        this.initApp();
                        this.loginLoading = false;
                    }, 1500);
                },
                
                // ===== åŸæœ‰æ–¹æ³• =====
                
                // åˆå§‹åŒ–åº”ç”¨
                async initApp() {
                    try {
                        this.loadingManager.updateProgress(10, 0);

                        // åˆå§‹åŒ–æ•°æ®åº“
                        await this.db.init();
                        this.loadingManager.updateProgress(30, 1);

                        // åˆ†æ‰¹åŠ è½½åˆå§‹æ•°æ®
                        await this.loadInitialData();
                        this.loadingManager.updateProgress(60, 2);

                        // æ„å»ºç´¢å¼•
                        this.buildMaps();
                        this.loadingManager.updateProgress(80, 3);

                        // æ ‡è®°åŠ è½½å®Œæˆ
                        this.isLoading = false;
                        this.loadTime = Date.now() - this.startTime;
                        this.loadingManager.updateProgress(100, 4);

                        // å»¶è¿Ÿåˆå§‹åŒ–å›¾è¡¨
                        this.$nextTick(() => {
                            this.lazyLoadCharts();
                        });

                    } catch (error) {
                        console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                        this.showToast('åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                    }
                },

                // åˆ†æ‰¹åŠ è½½åˆå§‹æ•°æ®
                async loadInitialData() {
                    try {
                        const [allPhones, accounts, bills, settings] = await Promise.all([
                            this.db.getAll('phones'),
                            this.db.getAll('accounts'),
                            this.db.getAll('bills'),
                            this.db.get('settings', 'general')
                        ]);
                        
                        this.totalDataCount = (allPhones || []).length;
                        
                        // åˆ†æ‰¹åŠ è½½æ‰‹æœºå·ï¼ˆé¦–æ‰¹50æ¡ï¼‰
                        this.phones = (allPhones || []).slice(0, this.batchSize);
                        this.loadedDataCount = this.phones.length;
                        this.hasMoreData = this.loadedDataCount < this.totalDataCount;
                        this.remainingCount = this.totalDataCount - this.loadedDataCount;
                        
                        // ä¿å­˜å®Œæ•´æ•°æ®ä»¥å¤‡åç»­åŠ è½½
                        this.allPhonesData = allPhones || [];
                        
                        this.accounts = accounts || [];
                        this.bills = bills || [];
                        
                        if (settings) {
                            this.settings = settings.value;
                        }
                        
                        // æ›´æ–°å¹³å°åˆ—è¡¨
                        this.platformList = this.platforms.join(', ');
                        
                    } catch (error) {
                        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                        throw error;
                    }
                },

                // åŠ è½½æ›´å¤šæ•°æ®
                loadMoreData() {
                    const nextBatch = this.allPhonesData.slice(this.loadedDataCount, this.loadedDataCount + this.batchSize);
                    this.phones.push(...nextBatch);
                    this.loadedDataCount = this.phones.length;
                    this.hasMoreData = this.loadedDataCount < this.totalDataCount;
                    this.remainingCount = this.totalDataCount - this.loadedDataCount;
                    
                    this.buildMaps();
                    this.showToast(`å·²åŠ è½½ ${nextBatch.length} æ¡æ•°æ®`);
                },

                // æ‰¹é‡åŠ è½½æ•°æ®
                async batchLoadData() {
                    if (this.hasMoreData) {
                        this.loadMoreData();
                    } else {
                        // ç”Ÿæˆæµ‹è¯•æ•°æ®
                        await this.generateBatchTestData();
                    }
                },

                // å»¶è¿ŸåŠ è½½å›¾è¡¨
                async lazyLoadCharts() {
                    if (this.chartLibLoaded) {
                        this.initCharts();
                        return;
                    }

                    try {
                        // åŠ¨æ€åŠ è½½Chart.js
                        const script = document.createElement('script');
                        script.src = './libs/chart.min.js';
                        script.onload = () => {
                            this.chartLibLoaded = true;
                            this.chartsLoaded = true;
                            this.initCharts();
                        };
                        document.head.appendChild(script);
                    } catch (error) {
                        console.error('Chart.jsåŠ è½½å¤±è´¥:', error);
                    }
                },

                // æ ‡ç­¾åˆ‡æ¢
                switchTab(tab) {
                    this.currentTab = tab;
                    
                    // åˆ‡æ¢åˆ°ä»ªè¡¨ç›˜æ—¶æ‰åˆå§‹åŒ–å›¾è¡¨
                    if (tab === 'dashboard' && !this.chartsLoaded && this.chartLibLoaded) {
                        this.$nextTick(() => {
                            this.initCharts();
                        });
                    }
                },

                // è™šæ‹Ÿæ»šåŠ¨å¤„ç†
                handleScroll(event) {
                    this.scrollTop = event.target.scrollTop;
                    this.updateVisibleRange();
                },
                
                updateVisibleRange() {
                    this.visibleStart = Math.floor(this.scrollTop / this.itemHeight);
                    this.visibleEnd = Math.ceil((this.scrollTop + this.containerHeight) / this.itemHeight);
                    this.visibleCount = this.visibleEnd - this.visibleStart;
                    
                    // æ›´æ–°å†…å­˜ä¼˜åŒ–æŒ‡æ ‡
                    const totalPossible = this.filteredPhones.length;
                    const actualRendered = this.visibleCount + this.bufferSize * 2;
                    this.memoryOptimization = totalPossible > 0 ? Math.round((1 - actualRendered / totalPossible) * 100) : 0;
                },
                
                // é˜²æŠ–æœç´¢
                debouncedSearch() {
                    clearTimeout(this.searchDebounceTimer);
                    this.searchDebounceTimer = setTimeout(() => {
                        this.debouncedPhoneSearch = this.phoneSearch;
                    }, 300);
                },
                
                // æ„å»ºMapç´¢å¼•
                buildMaps() {
                    this.phoneMap = new Map(this.phones.map(p => [p.id, p]));
                    
                    this.accountsByPhoneMap = new Map();
                    this.accounts.forEach(acc => {
                        if (!this.accountsByPhoneMap.has(acc.phoneId)) {
                            this.accountsByPhoneMap.set(acc.phoneId, []);
                        }
                        this.accountsByPhoneMap.get(acc.phoneId).push(acc);
                    });
                },
                
                // ä½¿ç”¨Mapä¼˜åŒ–çš„æŸ¥è¯¢
                getPhoneNumber(phoneId) {
                    const phone = this.phoneMap.get(phoneId);
                    return phone ? phone.number : 'æœªçŸ¥';
                },
                
                // è´¦å·å…³è”åŠŸèƒ½å¢å¼º
                setAccountFilterMode(mode) {
                    this.accountFilterMode = mode;
                    // é‡ç½®ç­›é€‰æ¡ä»¶
                    this.selectedPhoneForAccount = '';
                    this.selectedPlatform = '';
                    this.accountPhoneSearch = '';
                },
                
                // è·å–å¹³å°é¢œè‰²
                getPlatformColor(platform) {
                    const colors = {
                        'æŠ–éŸ³': '#fe2c55',
                        'å¿«æ‰‹': '#ff6600',
                        'å°çº¢ä¹¦': '#ff2442',
                        'Bç«™': '#00aeec',
                        'è§†é¢‘å·': '#07c160',
                        'çŸ¥ä¹': '#0066ff',
                        'å¾®åš': '#e6162d',
                        'ä»Šæ—¥å¤´æ¡': '#ff4500',
                        'YouTube': '#ff0000',
                        'TikTok': '#000000'
                    };
                    return colors[platform] || '#666';
                },
                
                // è·å–å¹³å°æ ·å¼ç±»
                getPlatformClass(platform) {
                    return 'platform-' + platform.toLowerCase().replace(/[^a-z0-9]/g, '');
                },
                
                // å¿«é€ŸæŸ¥è¯¢åŠŸèƒ½
                quickQuery() {
                    if (!this.quickQueryPhone.trim()) {
                        this.quickQueryResult = null;
                        return;
                    }
                    
                    const phoneNumber = this.quickQueryPhone.trim();
                    const phone = this.phones.find(p => p.number.includes(phoneNumber));
                    
                    if (!phone) {
                        this.quickQueryResult = {
                            accountCount: 0,
                            platforms: [],
                            phoneStatus: 'æœªæ‰¾åˆ°',
                            phoneOwner: '',
                            phoneCarrier: ''
                        };
                        this.showToast('æœªæ‰¾åˆ°åŒ¹é…çš„æ‰‹æœºå·', 'error');
                        return;
                    }
                    
                    const relatedAccounts = this.accounts.filter(acc => acc.phoneId === phone.id);
                    const platforms = [...new Set(relatedAccounts.map(acc => acc.platform))];
                    const normalAccounts = relatedAccounts.filter(acc => acc.status === 'normal').length;
                    
                    this.quickQueryResult = {
                        accountCount: relatedAccounts.length,
                        normalAccountCount: normalAccounts,
                        platforms: platforms,
                        phoneStatus: this.statusText[phone.status] || 'æœªçŸ¥',
                        phoneOwner: phone.owner,
                        phoneCarrier: phone.carrier,
                        monthlyFee: phone.monthlyFee
                    };
                    
                    this.showToast('æŸ¥è¯¢æˆåŠŸ');
                    
                    // è‡ªåŠ¨åˆ‡æ¢åˆ°è´¦å·å…³è”é¡µé¢å¹¶ç­›é€‰è¯¥å·ç 
                    setTimeout(() => {
                        this.currentTab = 'accounts';
                        this.accountFilterMode = 'phone';
                        this.selectedPhoneForAccount = phone.id;
                    }, 1000);
                },
                
                // æ¸…é™¤å¿«é€ŸæŸ¥è¯¢ç»“æœ
                clearQuickQuery() {
                    this.quickQueryPhone = '';
                    this.quickQueryResult = null;
                },
                
                // æ€§èƒ½ç›‘æ§
                togglePerformance() {
                    this.showPerformance = !this.showPerformance;
                    if (this.showPerformance) {
                        this.startFPSMonitor();
                    } else {
                        this.stopFPSMonitor();
                    }
                },
                
                startFPSMonitor() {
                    const updateFPS = () => {
                        const now = Date.now();
                        const delta = now - this.lastFrameTime;
                        this.currentFPS = Math.round(1000 / delta);
                        this.lastFrameTime = now;
                        this.fpsInterval = requestAnimationFrame(updateFPS);
                    };
                    updateFPS();
                },
                
                stopFPSMonitor() {
                    if (this.fpsInterval) {
                        cancelAnimationFrame(this.fpsInterval);
                        this.fpsInterval = null;
                    }
                },

                // å›¾è¡¨åˆå§‹åŒ–ï¼ˆå¸¦å†…å­˜æ³„æ¼ä¿®å¤ï¼‰
                initCharts() {
                    if (!window.Chart) return;
                    
                    // å…ˆé”€æ¯æ—§çš„Chartå®ä¾‹
                    if (this.costChart) {
                        this.costChart.destroy();
                        this.costChart = null;
                    }
                    if (this.billChart) {
                        this.billChart.destroy();
                        this.billChart = null;
                    }
                    
                    const costCtx = document.getElementById('costChart');
                    if (costCtx) {
                        this.costChart = new Chart(costCtx, {
                            type: 'line',
                            data: {
                                labels: this.getLastSixMonths(),
                                datasets: [{
                                    label: 'æœˆåº¦è´¹ç”¨',
                                    data: this.getMonthlyTrend(),
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: {
                                    duration: 0
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }
                    
                    const billCtx = document.getElementById('billChart');
                    if (billCtx) {
                        this.billChart = new Chart(billCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['åŸºç¡€è´¹ç”¨', 'é¢å¤–è´¹ç”¨'],
                                datasets: [{
                                    data: [this.monthlyBaseFee, this.monthlyExtraFee],
                                    backgroundColor: ['#667eea', '#764ba2']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: {
                                    duration: 0
                                }
                            }
                        });
                    }
                },
                
                updateCharts() {
                    try {
                        if (this.costChart && typeof this.costChart.update === 'function') {
                            const monthlyData = this.getMonthlyTrend();
                            if (this.costChart.data && this.costChart.data.datasets && this.costChart.data.datasets[0]) {
                                this.costChart.data.datasets[0].data = monthlyData;
                                this.costChart.update('none');
                            }
                        }
                        
                        if (this.billChart && typeof this.billChart.update === 'function') {
                            const billData = [this.monthlyBaseFee, this.monthlyExtraFee];
                            if (this.billChart.data && this.billChart.data.datasets && this.billChart.data.datasets[0]) {
                                this.billChart.data.datasets[0].data = billData;
                                this.billChart.update('none');
                            }
                        }
                    } catch (error) {
                        console.warn('å›¾è¡¨æ›´æ–°å¤±è´¥:', error);
                        // é¿å…æ— é™å¾ªç¯ï¼Œä¸åœ¨è¿™é‡Œé‡æ–°æŠ›å‡ºå¼‚å¸¸
                    }
                },
                
                getLastSixMonths() {
                    const months = [];
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        months.push(date.toISOString().slice(0, 7));
                    }
                    return months;
                },
                
                getMonthlyTrend() {
                    return this.getLastSixMonths().map(month => {
                        return this.bills
                            .filter(b => b.yearMonth === month)
                            .reduce((sum, b) => sum + b.totalFee, 0);
                    });
                },

                // è¡¨å•æ“ä½œ
                getEmptyPhoneForm() {
                    return {
                        number: '',
                        carrier: 'ä¸­å›½ç§»åŠ¨',
                        status: 'active',
                        packageType: '',
                        monthlyFee: 0,
                        owner: '',
                        purpose: []
                    };
                },
                
                getEmptyAccountForm() {
                    return {
                        phoneId: '',
                        platform: 'æŠ–éŸ³',
                        accountName: '',
                        accountId: '',
                        purpose: 'main',
                        status: 'normal',
                        followers: 0,
                        notes: ''
                    };
                },
                
                getEmptyBillForm() {
                    return {
                        phoneId: '',
                        yearMonth: new Date().toISOString().slice(0, 7),
                        baseFee: 0,
                        extraFee: 0,
                        totalFee: 0,
                        rechargeAmount: 0,
                        balance: 0
                    };
                },

                openPhoneModal(phone = null) {
                    if (phone) {
                        this.editingPhone = phone;
                        this.phoneForm = { ...phone };
                    } else {
                        this.editingPhone = null;
                        this.phoneForm = this.getEmptyPhoneForm();
                    }
                    this.showPhoneModal = true;
                },
                
                closePhoneModal() {
                    this.showPhoneModal = false;
                    this.phoneForm = this.getEmptyPhoneForm();
                    this.editingPhone = null;
                },
                
                async savePhone() {
                    try {
                        if (!this.phoneForm.number || this.phoneForm.number.length !== 11) {
                            this.showToast('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·', 'error');
                            return;
                        }
                        
                        const phoneData = {
                            ...this.phoneForm,
                            totalFee: this.phoneForm.monthlyFee || 0,
                            updatedAt: new Date().toISOString()
                        };
                        
                        if (this.editingPhone) {
                            phoneData.id = this.editingPhone.id;
                            phoneData.createdAt = this.editingPhone.createdAt;
                            // åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„å¯¹è±¡å‰¯æœ¬ï¼Œé¿å…DataCloneError
                            const cleanPhoneData = {
                                id: phoneData.id,
                                number: phoneData.number,
                                carrier: phoneData.carrier,
                                plan: phoneData.plan,
                                monthlyFee: phoneData.monthlyFee,
                                status: phoneData.status,
                                notes: phoneData.notes,
                                totalFee: phoneData.totalFee,
                                createdAt: phoneData.createdAt,
                                updatedAt: phoneData.updatedAt
                            };
                            await this.db.update('phones', cleanPhoneData);
                            const index = this.phones.findIndex(p => p.id === cleanPhoneData.id);
                            if (index !== -1) {
                                this.phones[index] = cleanPhoneData;
                            }
                            // åŒæ—¶æ›´æ–°å…¨é‡æ•°æ®
                            const allIndex = this.allPhonesData.findIndex(p => p.id === cleanPhoneData.id);
                            if (allIndex !== -1) {
                                this.allPhonesData[allIndex] = cleanPhoneData;
                            }
                        } else {
                            phoneData.id = this.generateId();
                            phoneData.createdAt = new Date().toISOString();
                            // åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„å¯¹è±¡å‰¯æœ¬ï¼Œé¿å…DataCloneError
                            const cleanPhoneData = {
                                id: phoneData.id,
                                number: phoneData.number,
                                carrier: phoneData.carrier,
                                plan: phoneData.plan,
                                monthlyFee: phoneData.monthlyFee,
                                status: phoneData.status,
                                notes: phoneData.notes,
                                totalFee: phoneData.totalFee,
                                createdAt: phoneData.createdAt
                            };
                            await this.db.add('phones', cleanPhoneData);
                            this.phones.push(cleanPhoneData);
                            this.allPhonesData.push(cleanPhoneData);
                            this.totalDataCount++;
                            this.loadedDataCount++;
                        }
                        
                        this.buildMaps();
                        this.closePhoneModal();
                        this.showToast('ä¿å­˜æˆåŠŸ');
                    } catch (error) {
                        console.error('ä¿å­˜æ‰‹æœºå·å¤±è´¥:', error);
                        this.showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    }
                },
                
                editPhone(phone) {
                    this.openPhoneModal(phone);
                },
                
                async deletePhone(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥å·ç å—ï¼Ÿç›¸å…³çš„è´¦å·å’Œè´¦å•ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) return;
                    
                    await this.db.delete('phones', id);
                    this.phones = this.phones.filter(p => p.id !== id);
                    this.allPhonesData = this.allPhonesData.filter(p => p.id !== id);
                    
                    const relatedAccounts = this.accounts.filter(a => a.phoneId === id);
                    for (const account of relatedAccounts) {
                        await this.db.delete('accounts', account.id);
                    }
                    this.accounts = this.accounts.filter(a => a.phoneId !== id);
                    
                    const relatedBills = this.bills.filter(b => b.phoneId === id);
                    for (const bill of relatedBills) {
                        await this.db.delete('bills', bill.id);
                    }
                    this.bills = this.bills.filter(b => b.phoneId !== id);
                    
                    this.totalDataCount--;
                    this.loadedDataCount--;
                    this.remainingCount = Math.max(0, this.totalDataCount - this.loadedDataCount);
                    
                    this.buildMaps();
                    this.showToast('åˆ é™¤æˆåŠŸ');
                },

                // ç”Ÿæˆæ‰¹é‡æµ‹è¯•æ•°æ®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
                async generateBatchTestData() {
                    const startTime = Date.now();
                    const batchCount = this.batchSize;
                    
                    const transaction = this.db.db.transaction(['phones'], 'readwrite');
                    const phoneStore = transaction.objectStore('phones');
                    
                    const phonePromises = [];
                    const carriers = ['ä¸­å›½ç§»åŠ¨', 'ä¸­å›½è”é€š', 'ä¸­å›½ç”µä¿¡'];
                    const packageTypes = ['ç•…äº«å¥—é¤', '5Gå¥—é¤', 'æµé‡ç‹', 'å•†åŠ¡å¥—é¤', 'å­¦ç”Ÿå¥—é¤'];
                    const owners = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'é™ˆä¸ƒ', 'åˆ˜å…«'];
                    const statuses = ['active', 'active', 'active', 'inactive', 'cancelled'];
                    
                    for (let i = 0; i < batchCount; i++) {
                        const phone = {
                            id: this.generateId(),
                            number: `1${3 + Math.floor(Math.random() * 7)}${Math.random().toString().slice(2, 11)}`,
                            carrier: carriers[Math.floor(Math.random() * carriers.length)],
                            status: statuses[Math.floor(Math.random() * statuses.length)],
                            packageType: packageTypes[Math.floor(Math.random() * packageTypes.length)],
                            monthlyFee: Math.floor(Math.random() * 200) + 50,
                            owner: owners[Math.floor(Math.random() * owners.length)],
                            purpose: [],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        phonePromises.push(phoneStore.add(phone));
                        this.phones.push(phone);
                        this.allPhonesData.push(phone);
                    }
                    
                    await Promise.all(phonePromises);
                    
                    this.totalDataCount += batchCount;
                    this.loadedDataCount += batchCount;
                    this.buildMaps();
                    
                    const endTime = Date.now();
                    const duration = ((endTime - startTime) / 1000).toFixed(2);
                    
                    this.showToast(`ç”Ÿæˆ${batchCount}æ¡æµ‹è¯•æ•°æ®æˆåŠŸï¼Œè€—æ—¶${duration}ç§’`);
                },

                // å…¶ä»–æ–¹æ³•ä¿æŒåŸæ ·...
                openAccountModal(account = null) {
                    if (account) {
                        this.editingAccount = account;
                        this.accountForm = { ...account };
                    } else {
                        this.editingAccount = null;
                        this.accountForm = this.getEmptyAccountForm();
                        // æ ¹æ®å½“å‰ç­›é€‰æ¨¡å¼è®¾ç½®é»˜è®¤å€¼
                        if (this.accountFilterMode === 'phone' && this.selectedPhoneForAccount) {
                            this.accountForm.phoneId = this.selectedPhoneForAccount;
                        }
                        if (this.accountFilterMode === 'platform' && this.selectedPlatform) {
                            this.accountForm.platform = this.selectedPlatform;
                        }
                    }
                    this.showAccountModal = true;
                },
                
                closeAccountModal() {
                    this.showAccountModal = false;
                    this.accountForm = this.getEmptyAccountForm();
                    this.editingAccount = null;
                },

                async saveAccount() {
                    if (!this.accountForm.phoneId || !this.accountForm.accountName) {
                        this.showToast('è¯·å¡«å†™å¿…è¦ä¿¡æ¯', 'error');
                        return;
                    }
                    
                    const accountData = {
                        ...this.accountForm,
                        followers: parseInt(this.accountForm.followers) || 0,
                        updatedAt: new Date().toISOString()
                    };
                    
                    try {
                        if (this.editingAccount) {
                            accountData.id = this.editingAccount.id;
                            await this.db.update('accounts', accountData);
                            const index = this.accounts.findIndex(a => a.id === accountData.id);
                            if (index !== -1) {
                                this.accounts[index] = accountData;
                            }
                        } else {
                            accountData.id = this.generateId();
                            accountData.createdAt = new Date().toISOString();
                            await this.db.add('accounts', accountData);
                            this.accounts.push(accountData);
                        }
                        
                        this.buildMaps();
                        this.closeAccountModal();
                        this.showToast('ä¿å­˜æˆåŠŸ');
                    } catch (error) {
                        console.error('ä¿å­˜è´¦å·å¤±è´¥:', error);
                        this.showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    }
                },
                
                editAccount(account) {
                    this.openAccountModal(account);
                },
                
                async deleteAccount(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥è´¦å·å—ï¼Ÿ')) return;
                    
                    await this.db.delete('accounts', id);
                    this.accounts = this.accounts.filter(a => a.id !== id);
                    this.buildMaps();
                    this.showToast('åˆ é™¤æˆåŠŸ');
                },

                openBillModal(bill = null) {
                    if (bill) {
                        this.editingBill = bill;
                        this.billForm = { ...bill };
                    } else {
                        this.editingBill = null;
                        this.billForm = this.getEmptyBillForm();
                    }
                    this.showBillModal = true;
                },
                
                closeBillModal() {
                    this.showBillModal = false;
                    this.billForm = this.getEmptyBillForm();
                    this.editingBill = null;
                },
                
                async saveBill() {
                    if (!this.billForm.phoneId) {
                        this.showToast('è¯·é€‰æ‹©æ‰‹æœºå·', 'error');
                        return;
                    }
                    
                    const billData = {
                        ...this.billForm,
                        totalFee: this.billForm.baseFee + this.billForm.extraFee,
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (this.editingBill) {
                        billData.id = this.editingBill.id;
                        await this.db.update('bills', billData);
                        const index = this.bills.findIndex(b => b.id === billData.id);
                        if (index !== -1) {
                            this.bills[index] = billData;
                        }
                    } else {
                        billData.id = this.generateId();
                        billData.createdAt = new Date().toISOString();
                        await this.db.add('bills', billData);
                        this.bills.push(billData);
                    }
                    
                    this.closeBillModal();
                    this.updateCharts();
                    this.showToast('ä¿å­˜æˆåŠŸ');
                },
                
                editBill(bill) {
                    this.openBillModal(bill);
                },
                
                async deleteBill(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥è´¦å•å—ï¼Ÿ')) return;
                    
                    await this.db.delete('bills', id);
                    this.bills = this.bills.filter(b => b.id !== id);
                    this.updateCharts();
                    this.showToast('åˆ é™¤æˆåŠŸ');
                },

                // å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
                async importPhones() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        const text = await file.text();
                        try {
                            const data = JSON.parse(text);
                            for (const phone of data) {
                                phone.id = this.generateId();
                                phone.createdAt = new Date().toISOString();
                                phone.updatedAt = new Date().toISOString();
                                await this.db.add('phones', phone);
                                this.phones.push(phone);
                                this.allPhonesData.push(phone);
                            }
                            this.totalDataCount += data.length;
                            this.loadedDataCount += data.length;
                            this.buildMaps();
                            this.showToast(`æˆåŠŸå¯¼å…¥ ${data.length} ä¸ªå·ç `);
                        } catch (error) {
                            this.showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                        }
                    };
                    input.click();
                },
                
                exportPhones() {
                    const data = JSON.stringify(this.phones, null, 2);
                    this.downloadFile(data, 'phones.json', 'application/json');
                    this.showToast('å¯¼å‡ºæˆåŠŸ');
                },
                
                async importBills() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        const text = await file.text();
                        try {
                            const data = JSON.parse(text);
                            for (const bill of data) {
                                bill.id = this.generateId();
                                bill.createdAt = new Date().toISOString();
                                bill.updatedAt = new Date().toISOString();
                                await this.db.add('bills', bill);
                                this.bills.push(bill);
                            }
                            this.updateCharts();
                            this.showToast(`æˆåŠŸå¯¼å…¥ ${data.length} æ¡è´¦å•`);
                        } catch (error) {
                            this.showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                        }
                    };
                    input.click();
                },
                
                exportBillReport() {
                    const report = {
                        month: this.selectedMonth,
                        bills: this.filteredBills,
                        summary: {
                            total: this.filteredBills.reduce((sum, b) => sum + b.totalFee, 0),
                            baseFee: this.filteredBills.reduce((sum, b) => sum + b.baseFee, 0),
                            extraFee: this.filteredBills.reduce((sum, b) => sum + b.extraFee, 0),
                            recharge: this.filteredBills.reduce((sum, b) => sum + b.rechargeAmount, 0)
                        }
                    };
                    
                    const data = JSON.stringify(report, null, 2);
                    this.downloadFile(data, `bill-report-${this.selectedMonth}.json`, 'application/json');
                    this.showToast('æŠ¥è¡¨ç”ŸæˆæˆåŠŸ');
                },

                // æ•°æ®å¤‡ä»½æ¢å¤
                async backupData() {
                    const backup = {
                        version: '3.0',
                        timestamp: new Date().toISOString(),
                        data: {
                            phones: this.allPhonesData,
                            accounts: this.accounts,
                            bills: this.bills,
                            settings: this.settings
                        }
                    };
                    
                    const data = JSON.stringify(backup, null, 2);
                    this.downloadFile(data, `backup-${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
                    this.showToast('å¤‡ä»½æˆåŠŸ');
                },
                
                restoreData() {
                    // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.style.display = 'none';
                    
                    // æ·»åŠ åˆ°DOMä»¥ç¡®ä¿æµè§ˆå™¨å…¼å®¹æ€§
                    document.body.appendChild(input);
                    
                    input.onchange = async (e) => {
                        try {
                            const file = e.target.files[0];
                            if (!file) {
                                document.body.removeChild(input);
                                return;
                            }
                            
                            this.showToast('æ­£åœ¨æ¢å¤æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');
                            
                            const text = await file.text();
                            const backup = JSON.parse(text);
                            
                            // æ”¯æŒå¤šç§æ•°æ®æ ¼å¼
                            let restoreData;
                            if (backup.data) {
                                // æ ‡å‡†å¤‡ä»½æ ¼å¼
                                restoreData = backup.data;
                            } else if (backup.phoneNumbers) {
                                // æ—§æ ¼å¼æˆ–æµ‹è¯•æ ¼å¼
                                restoreData = {
                                    phones: backup.phoneNumbers,
                                    accounts: backup.accounts || [],
                                    bills: backup.bills || [],
                                    settings: backup.settings || {}
                                };
                            } else if (backup.phones) {
                                // ç›´æ¥åŒ…å«æ•°æ®çš„æ ¼å¼
                                restoreData = backup;
                            } else {
                                throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®ç»“æ„');
                            }
                            
                            // åˆ é™¤ç°æœ‰æ•°æ®ï¼ˆé€ä¸ªåˆ é™¤ï¼‰
                            console.log('æ­£åœ¨åˆ é™¤ç°æœ‰æ•°æ®...');
                            
                            // è·å–ç°æœ‰æ•°æ®å¹¶åˆ é™¤
                            const existingPhones = await this.db.getAll('phones');
                            const existingAccounts = await this.db.getAll('accounts');
                            const existingBills = await this.db.getAll('bills');
                            
                            // åˆ é™¤æ‰€æœ‰ç°æœ‰æ‰‹æœºå·ç 
                            for (const phone of existingPhones) {
                                try {
                                    await this.db.delete('phones', phone.id);
                                } catch (error) {
                                    console.warn('åˆ é™¤æ‰‹æœºå·ç å¤±è´¥:', error.message);
                                }
                            }
                            
                            // åˆ é™¤æ‰€æœ‰ç°æœ‰è´¦å·
                            for (const account of existingAccounts) {
                                try {
                                    await this.db.delete('accounts', account.id);
                                } catch (error) {
                                    console.warn('åˆ é™¤è´¦å·å¤±è´¥:', error.message);
                                }
                            }
                            
                            // åˆ é™¤æ‰€æœ‰ç°æœ‰è´¦å•
                            for (const bill of existingBills) {
                                try {
                                    await this.db.delete('bills', bill.id);
                                } catch (error) {
                                    console.warn('åˆ é™¤è´¦å•å¤±è´¥:', error.message);
                                }
                            }
                            
                            console.log(`å·²åˆ é™¤ ${existingPhones.length} ä¸ªæ‰‹æœºå·ç , ${existingAccounts.length} ä¸ªè´¦å·, ${existingBills.length} ä¸ªè´¦å•`);
                            
                            // ä½¿ç”¨APIæ¢å¤æ•°æ®åˆ°åç«¯æ•°æ®åº“
                            let restoredPhones = 0;
                            let restoredAccounts = 0;
                            let restoredBills = 0;
                            
                            try {
                                // æ¢å¤æ‰‹æœºå·ç æ•°æ®
                                for (const phone of restoreData.phones || []) {
                                    try {
                                        await this.db.add('phones', phone);
                                        restoredPhones++;
                                    } catch (error) {
                                        console.warn('æ¢å¤æ‰‹æœºå·ç å¤±è´¥:', error.message, phone);
                                    }
                                }
                                
                                // æ¢å¤è´¦å·æ•°æ®
                                for (const account of restoreData.accounts || []) {
                                    try {
                                        await this.db.add('accounts', account);
                                        restoredAccounts++;
                                    } catch (error) {
                                        console.warn('æ¢å¤è´¦å·å¤±è´¥:', error.message, account);
                                    }
                                }
                                
                                // æ¢å¤è´¦å•æ•°æ®
                                for (const bill of restoreData.bills || []) {
                                    try {
                                        await this.db.add('bills', bill);
                                        restoredBills++;
                                    } catch (error) {
                                        console.warn('æ¢å¤è´¦å•å¤±è´¥:', error.message, bill);
                                    }
                                }
                                
                                console.log(`æ•°æ®æ¢å¤å®Œæˆ - æ‰‹æœºå·ç : ${restoredPhones}, è´¦å·: ${restoredAccounts}, è´¦å•: ${restoredBills}`);
                                
                            } catch (error) {
                                console.error('æ•°æ®æ¢å¤è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                                throw new Error(`æ•°æ®æ¢å¤å¤±è´¥: ${error.message}`);
                            }
                            
                            // ä»åç«¯é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®ä»¥ç¡®ä¿åŒæ­¥
                            await this.loadInitialData();
                            
                            // é‡æ–°æ„å»ºæ˜ å°„å’Œæ›´æ–°UI
                            this.buildMaps();
                            
                            // æš‚æ—¶è·³è¿‡å›¾è¡¨æ›´æ–°ä»¥é¿å…å †æ ˆæº¢å‡º
                            console.log('æ•°æ®æ¢å¤æˆåŠŸï¼Œè·³è¿‡å›¾è¡¨æ›´æ–°ä»¥é˜²æ­¢é¡µé¢å¡æ­»ã€‚å¦‚éœ€æŸ¥çœ‹æœ€æ–°å›¾è¡¨ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚');
                            
                            const totalRestored = restoredPhones + restoredAccounts + restoredBills;
                            this.showToast(`æ¢å¤æˆåŠŸï¼æ¢å¤äº† ${restoredPhones} ä¸ªæ‰‹æœºå·ç , ${restoredAccounts} ä¸ªè´¦å·, ${restoredBills} ä¸ªè´¦å•`, 'success');
                            
                        } catch (error) {
                            console.error('æ¢å¤æ•°æ®å¤±è´¥:', error);
                            this.showToast('æ¢å¤å¤±è´¥ï¼š' + (error.message || 'è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼'), 'error');
                        } finally {
                            // æ¸…ç†DOM
                            if (document.body.contains(input)) {
                                document.body.removeChild(input);
                            }
                        }
                    };
                    
                    // ç›‘å¬å–æ¶ˆäº‹ä»¶
                    input.oncancel = () => {
                        if (document.body.contains(input)) {
                            document.body.removeChild(input);
                        }
                    };
                    
                    // è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨
                    try {
                        input.click();
                    } catch (error) {
                        console.error('æ— æ³•æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨:', error);
                        this.showToast('æ— æ³•æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®', 'error');
                        if (document.body.contains(input)) {
                            document.body.removeChild(input);
                        }
                    }
                },
                
                async clearData() {
                    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
                    
                    await this.db.clear('phones');
                    await this.db.clear('accounts');
                    await this.db.clear('bills');
                    
                    this.phones = [];
                    this.accounts = [];
                    this.bills = [];
                    this.allPhonesData = [];
                    this.totalDataCount = 0;
                    this.loadedDataCount = 0;
                    this.hasMoreData = false;
                    this.remainingCount = 0;
                    
                    this.buildMaps();
                    this.updateCharts();
                    this.showToast('æ•°æ®å·²æ¸…ç©º');
                },

                // å·¥å…·æ–¹æ³•
                generateId() {
                    return Date.now().toString(36) + Math.random().toString(36).substr(2);
                },
                
                getStatusColor(status) {
                    const colors = {
                        active: '#4caf50',
                        inactive: '#ff9800',
                        cancelled: '#f44336'
                    };
                    return colors[status] || '#999';
                },
                
                getAccountStatusColor(status) {
                    const colors = {
                        normal: '#4caf50',
                        restricted: '#ff9800',
                        banned: '#f44336'
                    };
                    return colors[status] || '#999';
                },
                
                showToast(message, type = 'success') {
                    this.toast = {
                        show: true,
                        message,
                        type
                    };
                    
                    if (this.toastTimer) {
                        clearTimeout(this.toastTimer);
                    }
                    
                    this.toastTimer = setTimeout(() => {
                        this.toast.show = false;
                        this.toastTimer = null;
                    }, 3000);
                },
                
                downloadFile(content, filename, type) {
                    const blob = new Blob([content], { type });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            },

            created() {
                // åˆå§‹åŒ–é˜²æŠ–æœç´¢
                this.visibleCount = Math.ceil(this.containerHeight / this.itemHeight);
            },

            async mounted() {
                try {
                    // åˆå§‹åŒ–æ•°æ®åº“ï¼ˆç™»å½•å‰éœ€è¦ï¼‰
                    console.log('å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...');
                    await this.db.init();
                    console.log('æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
                    
                    // åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
                    console.log('åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·...');
                    await this.createDefaultAdmin();
                    console.log('é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·å¤„ç†å®Œæˆ');
                    
                    // ç”Ÿæˆåˆå§‹éªŒè¯ç 
                    this.generateCaptcha();
                    console.log('éªŒè¯ç ç”Ÿæˆå®Œæˆ');
                    
                    // æ£€æŸ¥ç™»å½•çŠ¶æ€
                    console.log('æ£€æŸ¥ç™»å½•çŠ¶æ€...');
                    const isLoggedIn = await this.checkLoginStatus();
                    
                    if (isLoggedIn) {
                        console.log('ç”¨æˆ·å·²ç™»å½•ï¼Œå¯åŠ¨åº”ç”¨');
                        // å·²ç™»å½•ï¼Œç›´æ¥å¯åŠ¨åº”ç”¨
                        await this.initApp();
                    } else {
                        console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢');
                        // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
                        this.showLoginPage = true;
                        this.isLoading = false; // éšè—éª¨æ¶å±
                    }
                } catch (error) {
                    console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                    // å‡ºé”™æ—¶ä¹Ÿè¦æ˜¾ç¤ºç•Œé¢ï¼Œé¿å…æ— é™åŠ è½½
                    this.showLoginPage = true;
                    this.isLoading = false;
                    this.loginError = 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                }
            },

            beforeUnmount() {
                // æ¸…ç†èµ„æºé˜²æ­¢å†…å­˜æ³„æ¼
                if (this.costChart) {
                    this.costChart.destroy();
                    this.costChart = null;
                }
                if (this.billChart) {
                    this.billChart.destroy();
                    this.billChart = null;
                }
                
                // æ¸…ç†å®šæ—¶å™¨
                if (this.searchDebounceTimer) {
                    clearTimeout(this.searchDebounceTimer);
                }
                if (this.toastTimer) {
                    clearTimeout(this.toastTimer);
                }
                
                // åœæ­¢FPSç›‘æ§
                this.stopFPSMonitor();
                
                // æ¸…ç†Mapç´¢å¼•
                this.phoneMap.clear();
                this.accountsByPhoneMap.clear();
            },

            watch: {
                // ç›‘å¬æ•°æ®å˜åŒ–ï¼Œé‡å»ºç´¢å¼•
                phones: {
                    deep: true,
                    handler() {
                        this.buildMaps();
                    }
                },
                accounts: {
                    deep: true,
                    handler() {
                        this.buildMaps();
                    }
                }
            }
        });

        app.mount('#app');
    </script>

    <!-- éå…³é”®CSSå¼‚æ­¥åŠ è½½ -->
    <style>
        /* è™šæ‹Ÿæ»šåŠ¨å®¹å™¨æ ·å¼ */
        .virtual-scroll-container {
            height: 600px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            position: relative;
        }

        .virtual-scroll-spacer {
            position: relative;
        }

        .virtual-scroll-items {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }

        .virtual-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #e5e5e5;
            transition: background 0.2s;
        }

        .virtual-item:hover {
            background: #f9f9f9;
        }

        /* æ€§èƒ½æŒ‡ç¤ºå™¨ */
        .performance-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .performance-value {
            color: #4caf50;
            font-weight: bold;
            margin-left: 10px;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            animation: slideInRight 0.3s;
            z-index: 2000;
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* è´¦å·å…³è”å¢å¼ºæ ·å¼ */
        .enhanced-search-bar {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filter-mode-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .filter-mode-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .filter-mode-btn:hover {
            background: #f0f0f0;
        }
        
        .filter-mode-btn.active:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }
        
        .account-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }
        
        .account-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .platform-badge {
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .quick-query-card {
            background: linear-gradient(135deg, #4caf50, #45a049) !important;
        }
        
        .quick-query-card input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .quick-query-card input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
        }
        
        /* å¹³å°ç‰¹è‰²æ ·å¼ */
        .platform-douyin {
            border-left-color: #fe2c55;
        }
        
        .platform-kuaishou {
            border-left-color: #ff6600;
        }
        
        .platform-xiaohongshu {
            border-left-color: #ff2442;
        }
        
        .platform-bilibili {
            border-left-color: #00aeec;
        }
        
        .platform-weixinshipinhao {
            border-left-color: #07c160;
        }
        
        .platform-zhihu {
            border-left-color: #0066ff;
        }
        
        .platform-weibo {
            border-left-color: #e6162d;
        }
        
        .platform-jinritoutiao {
            border-left-color: #ff4500;
        }
        
        .platform-youtube {
            border-left-color: #ff0000;
        }
        
        .platform-tiktok {
            border-left-color: #000000;
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .enhanced-search-bar {
                padding: 15px;
            }
            
            .filter-mode-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .account-card {
                margin-bottom: 15px;
            }
            
            .account-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .search-input {
                margin-bottom: 10px;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-accounts {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
            color: #666;
        }
        
        .loading-accounts::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>